---
import type { Product } from '@/lib/api';

interface Props {
  product: Product;
}

const { product } = Astro.props;

const image = product.image || product.thumbnailUrl || (product.images && product.images[0]) || '/placeholder.jpg';

// Convertir precios a números (Prisma Decimal se serializa como string)
const price = typeof product.price === 'string' ? parseFloat(product.price) : product.price;
const compareAtPrice = product.compareAtPrice ? (typeof product.compareAtPrice === 'string' ? parseFloat(product.compareAtPrice) : product.compareAtPrice) : null;

const hasDiscount = compareAtPrice && compareAtPrice > price;
const discountPercent = hasDiscount
  ? Math.round(((compareAtPrice! - price) / compareAtPrice!) * 100)
  : 0;

// Rating (mock por ahora)
const rating = 4.5;
const fullStars = Math.floor(rating);
const hasHalfStar = rating % 1 >= 0.5;
const totalReviews = 42;
---

<div class="bg-surface-light rounded-xl shadow-sm border border-gray-100 hover:shadow-xl transition group">
  <!-- Imagen con Badge -->
  <div class="relative">
    {hasDiscount && (
      <span class="absolute top-3 left-3 bg-accent text-white text-xs font-bold px-2 py-1 rounded z-10">
        -{discountPercent}%
      </span>
    )}
    {product.isNew && !hasDiscount && (
      <span class="absolute top-3 left-3 bg-primary text-secondary text-xs font-bold px-2 py-1 rounded z-10">
        NUEVO
      </span>
    )}

    <div class="aspect-square bg-gray-50 rounded-t-xl overflow-hidden">
      <img
        src={image}
        alt={product.name}
        class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
        loading="lazy"
      />
    </div>

    {product.stock === 0 && (
      <div class="absolute inset-0 bg-black/70 flex items-center justify-center rounded-t-xl">
        <span class="text-white font-bold text-lg">AGOTADO</span>
      </div>
    )}
  </div>

  <!-- Info del producto -->
  <div class="p-4 pt-0">
    <!-- Categoría y botón favoritos -->
    <div class="flex items-start justify-between mb-1">
      {product.category && (
        <p class="text-xs text-gray-500">{product.category.name}</p>
      )}
      <button
        class="wishlist-toggle-btn text-gray-400 hover:text-red-500 transition-colors -mt-1"
        data-product-id={product.id}
        data-product-name={product.name}
        data-product-slug={product.slug}
        data-product-price={price}
        data-product-image={image}
        aria-label="Añadir a favoritos"
      >
        <i class="material-icons text-xl">favorite_border</i>
      </button>
    </div>

    <!-- Nombre -->
    <a href={`/producto/${product.slug}`}>
      <h3 class="font-bold text-secondary text-lg leading-tight mb-2 group-hover:text-gray-600 transition-colors line-clamp-2">
        {product.name}
      </h3>
    </a>

    <!-- Estrellas de rating -->
    <div class="flex items-center gap-1 mb-3">
      {Array.from({ length: fullStars }).map(() => (
        <i class="material-icons text-amber-400 text-sm">star</i>
      ))}
      {hasHalfStar && (
        <i class="material-icons text-amber-400 text-sm">star_half</i>
      )}
      {Array.from({ length: 5 - fullStars - (hasHalfStar ? 1 : 0) }).map(() => (
        <i class="material-icons text-gray-300 text-sm">star</i>
      ))}
      <span class="text-xs text-gray-400 ml-1">({totalReviews})</span>
    </div>

    <!-- Precio y botón -->
    <div class="flex items-center justify-between">
      <div>
        {hasDiscount && (
          <div class="text-gray-400 line-through text-xs">
            {compareAtPrice!.toFixed(2)}€
          </div>
        )}
        <div class="text-xl font-bold text-secondary">
          {price.toFixed(2)}€
        </div>
      </div>
      <button
        class="bg-secondary text-primary hover:bg-black p-2 rounded-lg transition shadow-md"
        aria-label="Añadir al carrito"
        data-product-id={product.id}
      >
        <i class="material-icons text-lg">add_shopping_cart</i>
      </button>
    </div>

    <!-- Aviso de stock bajo -->
    {product.stock > 0 && product.stock <= 5 && (
      <p class="text-xs text-orange-600 mt-2">
        ¡Solo quedan {product.stock} unidades!
      </p>
    )}
  </div>
</div>

<script>
  import { addToCart } from '@/lib/cart';
  import { addToWishlist, removeFromWishlist, isInWishlist } from '@/lib/wishlist';
  import { toastSuccess } from '@/lib/toast';

  // Añadir al carrito desde la tarjeta
  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar botones de favoritos
    const wishlistButtons = document.querySelectorAll('.wishlist-toggle-btn');
    wishlistButtons.forEach(btn => {
      const productId = (btn as HTMLElement).dataset.productId || '';
      const icon = btn.querySelector('i');

      // Inicializar estado
      if (isInWishlist(productId)) {
        icon!.textContent = 'favorite';
        btn.classList.add('text-red-500');
        btn.classList.remove('text-gray-400');
      }

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const button = btn as HTMLElement;
        const productId = button.dataset.productId || '';
        const productName = button.dataset.productName || '';
        const productSlug = button.dataset.productSlug || '';
        const productPrice = parseFloat(button.dataset.productPrice || '0');
        const productImage = button.dataset.productImage || '';

        if (isInWishlist(productId)) {
          removeFromWishlist(productId);
          icon!.textContent = 'favorite_border';
          btn.classList.remove('text-red-500');
          btn.classList.add('text-gray-400');
          toastSuccess('Eliminado de favoritos');
        } else {
          addToWishlist({
            productId,
            productName,
            productSlug,
            productImage,
            productPrice,
          });
          icon!.textContent = 'favorite';
          btn.classList.add('text-red-500');
          btn.classList.remove('text-gray-400');
          toastSuccess('Añadido a favoritos');
        }

        // Animación
        btn.classList.add('scale-125');
        setTimeout(() => {
          btn.classList.remove('scale-125');
        }, 200);
      });
    });

    const addToCartButtons = document.querySelectorAll('[data-product-id]:not(.wishlist-toggle-btn)');

    addToCartButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const productId = (button as HTMLElement).dataset.productId;

        if (!productId) return;

        // Obtener datos del producto desde el DOM
        const card = button.closest('.bg-surface-light');
        if (!card) return;

        const productName = card.querySelector('h3')?.textContent?.trim() || '';
        const priceText = card.querySelector('.text-xl.font-bold')?.textContent?.replace('€', '').trim();
        const price = priceText ? parseFloat(priceText) : 0;
        const imageUrl = card.querySelector('img')?.getAttribute('src') || '';
        const productSlug = card.querySelector('a')?.getAttribute('href')?.split('/').pop() || '';

        // Crear objeto del producto para el carrito (estructura correcta de CartItem)
        const cartItem = {
          productId: productId,
          productName: productName,
          productSlug: productSlug,
          productImage: imageUrl,
          quantity: 1,
          unitPrice: price,
        };

        // Añadir al carrito
        addToCart(cartItem);

        // Feedback visual
        button.classList.add('scale-90');
        setTimeout(() => {
          button.classList.remove('scale-90');
          // Mostrar mensaje de éxito (opcional)
          const icon = button.querySelector('i');
          if (icon) {
            const originalIcon = icon.textContent;
            icon.textContent = 'check';
            setTimeout(() => {
              icon.textContent = originalIcon;
            }, 1000);
          }
        }, 200);
      });
    });
  });
</script>
