---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
---

<Layout title="Iniciar Sesión - Deportes y Juguetes Eva" description="Inicia sesión en tu cuenta">
  <Header />

  <main class="bg-background-light min-h-screen py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
        <!-- Logo/Título -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-display font-extrabold uppercase italic text-secondary mb-2">
            Iniciar Sesión
          </h1>
          <p class="text-gray-600">Accede a tu cuenta</p>
        </div>

        <!-- Formulario -->
        <form id="login-form" class="space-y-6">
          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="tu@email.com"
            />
          </div>

          <!-- Contraseña -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Contraseña <span class="text-red-500">*</span>
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="••••••••"
            />
          </div>

          <!-- Error message -->
          <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
          </div>

          <!-- Botón -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-primary hover:bg-yellow-400 text-black font-bold py-3 px-8 rounded-lg uppercase tracking-wider transition-all transform hover:-translate-y-1 shadow-lg"
          >
            Iniciar Sesión
          </button>
        </form>

        <!-- Registro -->
        <div class="mt-6 text-center">
          <p class="text-gray-600">
            ¿No tienes cuenta?
            <a href="/registro" class="text-primary font-bold hover:underline">
              Regístrate aquí
            </a>
          </p>
        </div>

        <!-- Continuar sin cuenta -->
        <div class="mt-4 text-center">
          <a href="/" class="text-gray-500 text-sm hover:underline">
            Continuar sin iniciar sesión
          </a>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  import { login } from '@/lib/auth';
  import { toastSuccess, toastError } from '@/lib/toast';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    // Ocultar error previo
    errorMessage.classList.add('hidden');

    // Deshabilitar botón
    submitBtn.disabled = true;
    submitBtn.textContent = 'Iniciando sesión...';

    try {
      const result = await login(email, password);

      if (result.success) {
        toastSuccess('¡Bienvenido de nuevo!');

        // Redirigir a cuenta después de un breve delay
        setTimeout(() => {
          window.location.href = '/cuenta';
        }, 500);
      } else {
        errorMessage.textContent = result.message || 'Error al iniciar sesión';
        errorMessage.classList.remove('hidden');
        toastError(result.message || 'Error al iniciar sesión');
      }
    } catch (error) {
      console.error('Login error:', error);
      errorMessage.textContent = 'Error de conexión. Por favor intenta de nuevo.';
      errorMessage.classList.remove('hidden');
      toastError('Error de conexión');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Iniciar Sesión';
    }
  });
</script>
