---
export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import ProductCard from '@/components/ProductCard.astro';
import { getProductBySlug } from '@/lib/api';

const slug = Astro.params.slug || '';

// Obtener producto desde la API
let product: any;
let relatedProducts: any[] = [];

try {
  const result = await getProductBySlug(slug);
  product = result.product;
  relatedProducts = result.relatedProducts || [];
} catch (error) {
  console.error('Error al cargar producto:', error);
  return Astro.redirect('/404');
}

// Convertir precios de Prisma Decimal (string) a número
const price = typeof product.price === 'string' ? parseFloat(product.price) : product.price;
const compareAtPrice = product.compareAtPrice
  ? (typeof product.compareAtPrice === 'string' ? parseFloat(product.compareAtPrice) : product.compareAtPrice)
  : null;

// Calcular descuento
const hasDiscount = compareAtPrice && compareAtPrice > price;
const discountPercent = hasDiscount ? Math.round(((compareAtPrice - price) / compareAtPrice) * 100) : 0;

// Imagen principal
const mainImage = product.thumbnailUrl || (product.images && product.images[0]) || '/placeholder.jpg';
const productImages = product.images && product.images.length > 0 ? product.images : [mainImage];

// Rating (mock por ahora, se puede añadir al modelo después)
const rating = 4.5;
const totalReviews = 42;

// Badge
const badge = product.isNew ? 'NUEVO' : (hasDiscount ? `-${discountPercent}%` : null);

// Stock
const stockStatus = product.stock > 0 ? (product.stock <= 5 ? `¡Solo ${product.stock} unidades!` : 'En stock') : 'Agotado';
---

<Layout title={`${product.name} - Deportes y Juguetes Eva`} description={product.description}>
  <Header />

  <main class="bg-background-light min-h-screen">
    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200">
      <div class="container mx-auto px-4 py-4">
        <nav class="flex items-center text-sm flex-wrap">
          <a href="/" class="text-gray-500 hover:text-secondary transition-colors">Inicio</a>
          <i class="material-icons text-gray-400 text-sm mx-2">chevron_right</i>
          {product.category && (
            <>
              <a href={`/${product.category.slug}`} class="text-gray-500 hover:text-secondary transition-colors">{product.category.name}</a>
              <i class="material-icons text-gray-400 text-sm mx-2">chevron_right</i>
            </>
          )}
          <span class="text-secondary font-medium truncate">{product.name}</span>
        </nav>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8 lg:py-12">
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Galería de Imágenes -->
        <div class="product-gallery flex flex-col-reverse lg:flex-row gap-4">
          <!-- Thumbnails -->
          <div class="flex lg:flex-col gap-4 overflow-x-auto lg:overflow-y-auto lg:h-[600px] no-scrollbar py-2 lg:py-0">
            {productImages.map((img, index) => (
              <button
                class={`thumbnail w-20 h-20 flex-shrink-0 border-2 rounded-lg overflow-hidden transition-all ${index === 0 ? 'border-primary' : 'border-gray-200 hover:border-primary'}`}
                data-image={img}
              >
                <img class="w-full h-full object-cover" src={img} alt={`${product.name} ${index + 1}`} />
              </button>
            ))}
          </div>

          <!-- Imagen Principal -->
          <div class="flex-1 aspect-square lg:aspect-auto lg:h-[600px] bg-white rounded-xl overflow-hidden shadow-sm relative group">
            <img
              id="main-image"
              class="w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-500"
              src={mainImage}
              alt={product.name}
            />
            {badge && (
              <span class="absolute top-4 left-4 bg-black text-primary text-xs font-bold px-3 py-1 uppercase tracking-wider rounded-sm">
                {badge}
              </span>
            )}
            {product.stock === 0 && (
              <div class="absolute inset-0 bg-black/70 flex items-center justify-center">
                <span class="text-white font-bold text-2xl">AGOTADO</span>
              </div>
            )}
          </div>
        </div>

        <!-- Información del Producto -->
        <div>
          <!-- Marca -->
          {product.brand && (
            <span class="inline-block bg-gray-800 text-white font-bold text-sm px-3 py-1 rounded mb-3">{product.brand}</span>
          )}

          <!-- Título -->
          <h1 class="text-3xl lg:text-5xl font-display font-extrabold uppercase italic text-secondary mb-4">
            {product.name}
          </h1>

          <!-- Rating -->
          <div class="flex items-center gap-2 mb-6">
            <div class="flex items-center gap-0.5">
              {Array.from({ length: Math.floor(rating) }).map(() => (
                <i class="material-icons text-amber-400 text-lg">star</i>
              ))}
              {rating % 1 !== 0 && (
                <i class="material-icons text-amber-400 text-lg">star_half</i>
              )}
            </div>
            <span class="text-sm text-gray-600">({totalReviews} reseñas)</span>
          </div>

          <!-- Precio -->
          <div class="flex items-center gap-4 mb-6">
            <p class="text-4xl font-bold text-secondary">{price.toFixed(2)}€</p>
            {hasDiscount && (
              <>
                <p class="text-xl text-gray-400 line-through">{compareAtPrice!.toFixed(2)}€</p>
                <span class="bg-accent text-white text-sm font-bold px-2 py-1 rounded">-{discountPercent}%</span>
              </>
            )}
          </div>

          <!-- Stock -->
          <div class="mb-4">
            <span class={`text-sm font-medium ${product.stock > 5 ? 'text-green-600' : product.stock > 0 ? 'text-orange-500' : 'text-red-600'}`}>
              {stockStatus}
            </span>
          </div>

          <!-- Descripción -->
          <p class="text-gray-600 leading-relaxed mb-8">
            {product.description || product.shortDescription || 'Sin descripción disponible.'}
          </p>

          <!-- Cantidad -->
          <div class="mb-8">
            <h3 class="text-sm font-medium text-secondary mb-4">Cantidad</h3>
            <div class="flex items-center border border-gray-200 rounded-lg w-32">
              <button class="px-4 py-2 hover:bg-gray-50 transition-colors" aria-label="Disminuir cantidad">
                <i class="material-icons text-gray-600">remove</i>
              </button>
              <input
                type="number"
                value="1"
                min="1"
                class="flex-1 text-center border-x border-gray-200 py-2 focus:outline-none"
              />
              <button class="px-4 py-2 hover:bg-gray-50 transition-colors" aria-label="Aumentar cantidad">
                <i class="material-icons text-gray-600">add</i>
              </button>
            </div>
          </div>

          <!-- Botones de Acción -->
          <div class="flex gap-4 mb-8">
            <button class="flex-1 bg-primary border border-transparent py-3 px-8 flex items-center justify-center text-base font-bold text-black hover:bg-yellow-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary uppercase tracking-wider rounded-lg shadow-lg hover:shadow-primary/50 transition-all duration-300 transform hover:-translate-y-1">
              <i class="material-icons mr-2">shopping_bag</i>
              Añadir al Carrito
            </button>
            <button class="border-2 border-gray-300 py-3 px-6 rounded-lg hover:border-red-500 hover:text-red-500 transition-colors" aria-label="Añadir a favoritos">
              <i class="material-icons">favorite_border</i>
            </button>
          </div>

          <!-- Acordeón Descripción -->
          <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
            <button class="accordion-button collapsed w-full flex justify-between items-center p-4 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
              <span class="font-bold text-secondary uppercase text-sm">Descripción</span>
              <i class="material-icons accordion-icon">expand_more</i>
            </button>
            <div class="accordion-content">
              <div class="p-4 bg-white border-t border-gray-200 text-sm text-gray-600">
                <p class="leading-relaxed">
                  {product.description || product.shortDescription || 'Sin descripción disponible.'}
                </p>
              </div>
            </div>
          </div>

          <!-- Acordeón Características -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button class="accordion-button collapsed w-full flex justify-between items-center p-4 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
              <span class="font-bold text-secondary uppercase text-sm">Características</span>
              <i class="material-icons accordion-icon">expand_more</i>
            </button>
            <div class="accordion-content">
              <div class="p-4 bg-white border-t border-gray-200 text-sm text-gray-600 space-y-2">
              {product.sku && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>SKU:</span>
                  <span class="font-medium text-secondary">{product.sku}</span>
                </div>
              )}
              {product.brand && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Marca:</span>
                  <span class="font-medium text-secondary">{product.brand}</span>
                </div>
              )}
              {product.color && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Color:</span>
                  <span class="font-medium text-secondary">{product.color}</span>
                </div>
              )}
              {product.category && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Categoría:</span>
                  <span class="font-medium text-secondary">{product.category.name}</span>
                </div>
              )}
              {product.sportType && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Deporte:</span>
                  <span class="font-medium text-secondary">{product.sportType}</span>
                </div>
              )}
              {product.isCollectible && product.collectionType && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Colección:</span>
                  <span class="font-medium text-secondary">{product.collectionType}</span>
                </div>
              )}
              </div>
            </div>
          </div>

          <!-- Beneficios -->
          <div class="mt-8 grid grid-cols-3 gap-3 text-center">
            <div class="bg-gray-500 rounded-lg p-4 shadow-sm flex flex-col items-center gap-2">
              <i class="material-icons text-white text-2xl">local_shipping</i>
              <p class="text-xs text-white font-bold">Envío gratis +50€</p>
            </div>
            <div class="bg-gray-500 rounded-lg p-4 shadow-sm flex flex-col items-center gap-2">
              <i class="material-icons text-white text-2xl">verified_user</i>
              <p class="text-xs text-white font-bold">Compra segura</p>
            </div>
            <div class="bg-gray-500 rounded-lg p-4 shadow-sm flex flex-col items-center gap-2">
              <i class="material-icons text-white text-2xl">sync</i>
              <p class="text-xs text-white font-bold">Devolución 30 días</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Productos Relacionados -->
      {relatedProducts.length > 0 && (
        <section class="mt-16 border-t border-gray-200 pt-12">
          <h2 class="text-3xl font-display font-extrabold uppercase italic text-secondary mb-8 relative inline-block">
            Productos Relacionados
            <span class="absolute bottom-0 left-0 w-[3ch] h-1 bg-primary"></span>
          </h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {relatedProducts.map((relProduct) => {
              const relPrice = typeof relProduct.price === 'string' ? parseFloat(relProduct.price) : relProduct.price;
              const relCompareAtPrice = relProduct.compareAtPrice
                ? (typeof relProduct.compareAtPrice === 'string' ? parseFloat(relProduct.compareAtPrice) : relProduct.compareAtPrice)
                : null;
              const relHasDiscount = relCompareAtPrice && relCompareAtPrice > relPrice;
              const relDiscountPercent = relHasDiscount ? Math.round(((relCompareAtPrice - relPrice) / relCompareAtPrice) * 100) : 0;
              const relImage = relProduct.thumbnailUrl || (relProduct.images && relProduct.images[0]) || '/placeholder.jpg';

              return (
                <a href={`/producto/${relProduct.slug}`} class="group relative bg-background-light rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300">
                  <div class="aspect-[4/5] bg-white overflow-hidden relative">
                    <img class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-500" src={relImage} alt={relProduct.name} />

                    {relHasDiscount && (
                      <div class="absolute top-2 right-2 bg-accent text-white text-xs font-bold px-2 py-1 rounded">
                        -{relDiscountPercent}%
                      </div>
                    )}
                    {relProduct.isNew && !relHasDiscount && (
                      <div class="absolute top-2 right-2 bg-primary text-black text-xs font-bold px-2 py-1 rounded">
                        NUEVO
                      </div>
                    )}
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-bold text-secondary mb-1 line-clamp-2">{relProduct.name}</h3>
                    {relProduct.category && (
                      <p class="text-sm text-gray-500 mb-2">{relProduct.category.name}</p>
                    )}
                    <div class="flex justify-between items-center">
                      <p class="text-lg font-bold text-secondary">{relPrice.toFixed(2)}€</p>
                      {relHasDiscount && (
                        <p class="text-sm text-gray-400 line-through">{relCompareAtPrice!.toFixed(2)}€</p>
                      )}
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )}
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Cambio de imagen principal al hacer click en thumbnail
  const thumbnails = document.querySelectorAll('.thumbnail');
  const mainImage = document.getElementById('main-image') as HTMLImageElement;

  thumbnails.forEach((thumb) => {
    thumb.addEventListener('click', () => {
      const newImage = thumb.getAttribute('data-image');
      if (newImage && mainImage) {
        mainImage.src = newImage;

        // Actualizar border de thumbnails
        thumbnails.forEach((t) => {
          t.classList.remove('border-primary');
          t.classList.add('border-gray-200');
        });
        thumb.classList.remove('border-gray-200');
        thumb.classList.add('border-primary');
      }
    });
  });

  // Contador de cantidad
  const quantityInput = document.querySelector('input[type="number"]') as HTMLInputElement;
  const decreaseBtn = document.querySelector('[aria-label="Disminuir cantidad"]');
  const increaseBtn = document.querySelector('[aria-label="Aumentar cantidad"]');

  decreaseBtn?.addEventListener('click', () => {
    const currentValue = parseInt(quantityInput.value);
    if (currentValue > 1) {
      quantityInput.value = (currentValue - 1).toString();
    }
  });

  increaseBtn?.addEventListener('click', () => {
    const currentValue = parseInt(quantityInput.value);
    quantityInput.value = (currentValue + 1).toString();
  });

  // Acordeones (múltiples)
  const accordionButtons = document.querySelectorAll('.accordion-button');

  accordionButtons.forEach((button) => {
    button.addEventListener('click', () => {
      // Solo alternar collapsed - el CSS hace el resto
      button.classList.toggle('collapsed');
    });
  });
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .accordion-button:not(.collapsed) + .accordion-content {
    max-height: 500px;
  }

  .accordion-icon {
    transition: transform 0.3s ease;
  }

  .accordion-button:not(.collapsed) .accordion-icon {
    transform: rotate(180deg);
  }
</style>
