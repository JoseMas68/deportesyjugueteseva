---
export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import ProductCard from '@/components/ProductCard.astro';
import ProductReviews from '@/components/ProductReviews.astro';
import { getProductBySlug } from '@/lib/api';

const slug = Astro.params.slug || '';

// Obtener producto desde la API
let product: any;
let relatedProducts: any[] = [];

try {
  const result = await getProductBySlug(slug);
  product = result.product;
  relatedProducts = result.relatedProducts || [];
} catch (error) {
  console.error('Error al cargar producto:', error);
  return Astro.redirect('/404');
}

// Convertir precios de Prisma Decimal (string) a número
const price = typeof product.price === 'string' ? parseFloat(product.price) : product.price;
const compareAtPrice = product.compareAtPrice
  ? (typeof product.compareAtPrice === 'string' ? parseFloat(product.compareAtPrice) : product.compareAtPrice)
  : null;

// Calcular descuento
const hasDiscount = compareAtPrice && compareAtPrice > price;
const discountPercent = hasDiscount ? Math.round(((compareAtPrice - price) / compareAtPrice) * 100) : 0;

// Imagen principal
const mainImage = product.thumbnailUrl || (product.images && product.images[0]) || '/placeholder.jpg';
const productImages = product.images && product.images.length > 0 ? product.images : [mainImage];

// Obtener rating real de las reseñas
let rating = 0;
let totalReviews = 0;
try {
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
  const reviewsResponse = await fetch(`${API_URL}/api/reviews?productId=${product.id}&status=approved`);
  if (reviewsResponse.ok) {
    const reviewsData = await reviewsResponse.json();
    rating = reviewsData.stats?.averageRating || 0;
    totalReviews = reviewsData.stats?.totalReviews || 0;
  }
} catch (error) {
  console.error('Error loading reviews:', error);
}

// Badge
const badge = product.isNew ? 'NUEVO' : (hasDiscount ? `-${discountPercent}%` : null);

// Stock
const stockStatus = product.stock > 0 ? (product.stock <= 5 ? `¡Solo ${product.stock} unidades!` : 'En stock') : 'Agotado';
---

<Layout title={`${product.name} - Deportes y Juguetes Eva`} description={product.description}>
  <Header />

  <main class="bg-background-light min-h-screen">
    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200">
      <div class="container mx-auto px-4 py-4">
        <nav class="flex items-center text-sm flex-wrap">
          <a href="/" class="text-gray-500 hover:text-secondary transition-colors">Inicio</a>
          <i class="material-icons text-gray-400 text-sm mx-2">chevron_right</i>
          {product.category && (
            <>
              <a href={`/${product.category.slug}`} class="text-gray-500 hover:text-secondary transition-colors">{product.category.name}</a>
              <i class="material-icons text-gray-400 text-sm mx-2">chevron_right</i>
            </>
          )}
          <span class="text-secondary font-medium truncate">{product.name}</span>
        </nav>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8 lg:py-12">
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Galería de Imágenes -->
        <div class="product-gallery flex flex-col-reverse lg:flex-row gap-4">
          <!-- Thumbnails -->
          <div class="flex lg:flex-col gap-4 overflow-x-auto lg:overflow-y-auto lg:h-[600px] no-scrollbar py-2 lg:py-0">
            {productImages.map((img, index) => (
              <button
                class={`thumbnail w-20 h-20 flex-shrink-0 border-2 rounded-lg overflow-hidden transition-all ${index === 0 ? 'border-primary' : 'border-gray-200 hover:border-primary'}`}
                data-image={img}
              >
                <img class="w-full h-full object-cover" src={img} alt={`${product.name} ${index + 1}`} />
              </button>
            ))}
          </div>

          <!-- Imagen Principal -->
          <div class="flex-1 aspect-square lg:aspect-auto lg:h-[600px] bg-white rounded-xl overflow-hidden shadow-sm relative group">
            <img
              id="main-image"
              class="w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-500"
              src={mainImage}
              alt={product.name}
            />
            {badge && (
              <span class="absolute top-4 left-4 bg-black text-primary text-xs font-bold px-3 py-1 uppercase tracking-wider rounded-sm">
                {badge}
              </span>
            )}
            {product.stock === 0 && (
              <div class="absolute inset-0 bg-black/70 flex items-center justify-center">
                <span class="text-white font-bold text-2xl">AGOTADO</span>
              </div>
            )}
          </div>
        </div>

        <!-- Información del Producto -->
        <div>
          <!-- Marca -->
          {product.brand && (
            <div class="mb-3">
              {product.brand.logoUrl ? (
                <img src={product.brand.logoUrl} alt={product.brand.name} class="h-6 w-auto object-contain" />
              ) : (
                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">{product.brand.name}</span>
              )}
            </div>
          )}

          <!-- Título -->
          <h1 class="text-3xl lg:text-5xl font-display font-extrabold uppercase italic text-secondary mb-4">
            {product.name}
          </h1>

          <!-- Rating -->
          {totalReviews > 0 && (
            <div class="flex items-center gap-2 mb-6">
              <div class="flex items-center gap-0.5">
                {Array.from({ length: Math.floor(rating) }).map(() => (
                  <i class="material-icons text-amber-400 text-lg">star</i>
                ))}
                {rating % 1 >= 0.5 && (
                  <i class="material-icons text-amber-400 text-lg">star_half</i>
                )}
                {Array.from({ length: 5 - Math.floor(rating) - (rating % 1 >= 0.5 ? 1 : 0) }).map(() => (
                  <i class="material-icons text-gray-300 text-lg">star_border</i>
                ))}
              </div>
              <span class="text-sm text-gray-600">{rating.toFixed(1)} ({totalReviews} {totalReviews === 1 ? 'reseña' : 'reseñas'})</span>
            </div>
          )}

          <!-- Precio -->
          <div class="flex items-center gap-4 mb-6">
            <p class="text-4xl font-bold text-secondary">{price.toFixed(2)}€</p>
            {hasDiscount && (
              <>
                <p class="text-xl text-gray-400 line-through">{compareAtPrice!.toFixed(2)}€</p>
                <span class="bg-accent text-white text-sm font-bold px-2 py-1 rounded">-{discountPercent}%</span>
              </>
            )}
          </div>

          <!-- Stock -->
          <div class="mb-4">
            <span class={`text-sm font-medium ${product.stock > 5 ? 'text-green-600' : product.stock > 0 ? 'text-orange-500' : 'text-red-600'}`}>
              {stockStatus}
            </span>
          </div>

          <!-- Descripción -->
          <p class="text-gray-600 leading-relaxed mb-8">
            {product.description || product.shortDescription || 'Sin descripción disponible.'}
          </p>

          <!-- Variantes -->
          {product.hasVariants && product.variants && product.variants.length > 0 && (
            <div class="mb-8 space-y-4" id="variants-section">
              {/* Tallas */}
              {product.variants.some((v: any) => v.size) && (
                <div>
                  <h3 class="text-sm font-medium text-secondary mb-3">Talla</h3>
                  <div class="flex flex-wrap gap-2" id="size-options">
                    {[...new Set(product.variants.filter((v: any) => v.size).map((v: any) => v.size))].map((size: string) => {
                      const variantsWithSize = product.variants.filter((v: any) => v.size === size);
                      const totalStock = variantsWithSize.reduce((sum: number, v: any) => sum + v.stock, 0);
                      const isOutOfStock = totalStock === 0;
                      return (
                        <button
                          type="button"
                          class={`size-option px-4 py-2 border-2 rounded-lg font-medium transition-all ${isOutOfStock ? 'border-gray-200 text-gray-300 cursor-not-allowed line-through' : 'border-gray-300 hover:border-secondary'}`}
                          data-size={size}
                          disabled={isOutOfStock}
                        >
                          {size}
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* Colores */}
              {product.variants.some((v: any) => v.color) && (
                <div>
                  <h3 class="text-sm font-medium text-secondary mb-3">Color: <span id="selected-color-name"></span></h3>
                  <div class="flex flex-wrap gap-2" id="color-options">
                    {[...new Map(product.variants.filter((v: any) => v.color).map((v: any) => [v.color, v])).values()].map((variant: any) => {
                      const variantsWithColor = product.variants.filter((v: any) => v.color === variant.color);
                      const totalStock = variantsWithColor.reduce((sum: number, v: any) => sum + v.stock, 0);
                      const isOutOfStock = totalStock === 0;
                      return (
                        <button
                          type="button"
                          class={`color-option w-10 h-10 rounded-full border-2 transition-all relative ${isOutOfStock ? 'opacity-30 cursor-not-allowed' : 'hover:scale-110'}`}
                          style={variant.colorHex ? `background-color: ${variant.colorHex}` : 'background-color: #ccc'}
                          data-color={variant.color}
                          data-color-hex={variant.colorHex || ''}
                          title={variant.color}
                          disabled={isOutOfStock}
                        >
                          {isOutOfStock && (
                            <span class="absolute inset-0 flex items-center justify-center">
                              <span class="w-full h-0.5 bg-red-500 rotate-45 absolute"></span>
                            </span>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* Stock de variante seleccionada */}
              <div id="variant-stock" class="text-sm hidden">
                <span class="text-gray-600">Stock disponible: </span>
                <span id="variant-stock-count" class="font-medium"></span>
              </div>

              {/* Datos de variantes para JS */}
              <script id="variants-data" type="application/json" set:html={JSON.stringify(product.variants)}></script>
            </div>
          )}

          <!-- Cantidad -->
          <div class="mb-8">
            <h3 class="text-sm font-medium text-secondary mb-4">Cantidad</h3>
            <div class="flex items-center border border-gray-200 rounded-lg w-32">
              <button class="px-4 py-2 hover:bg-gray-50 transition-colors" aria-label="Disminuir cantidad">
                <i class="material-icons text-gray-600">remove</i>
              </button>
              <input
                type="number"
                value="1"
                min="1"
                class="flex-1 text-center border-x border-gray-200 py-2 focus:outline-none"
              />
              <button class="px-4 py-2 hover:bg-gray-50 transition-colors" aria-label="Aumentar cantidad">
                <i class="material-icons text-gray-600">add</i>
              </button>
            </div>
          </div>

          <!-- Botones de Acción -->
          <div class="flex gap-4 mb-8">
            <button
              id="add-to-cart-btn"
              class="flex-1 bg-primary border border-transparent py-3 px-8 flex items-center justify-center text-base font-bold text-black hover:bg-yellow-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary uppercase tracking-wider rounded-lg shadow-lg hover:shadow-primary/50 transition-all duration-300 transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed"
              data-product-id={product.id}
              data-product-name={product.name}
              data-product-slug={product.slug}
              data-product-price={price}
              data-product-image={mainImage}
              data-product-stock={product.stock}
              data-has-variants={product.hasVariants && product.variants && product.variants.length > 0}
              disabled={product.hasVariants && product.variants && product.variants.length > 0 ? true : product.stock === 0}
            >
              <i class="material-icons mr-2" id="cart-icon">shopping_bag</i>
              <span id="cart-btn-text">{
                product.hasVariants && product.variants && product.variants.length > 0
                  ? 'Selecciona opciones'
                  : (product.stock === 0 ? 'Agotado' : 'Añadir al Carrito')
              }</span>
            </button>
            <button
              id="wishlist-btn"
              class="border-2 border-gray-300 py-3 px-6 rounded-lg hover:border-red-500 hover:text-red-500 transition-colors"
              aria-label="Añadir a favoritos"
              data-product-id={product.id}
              data-product-name={product.name}
              data-product-slug={product.slug}
              data-product-price={price}
              data-product-image={mainImage}
            >
              <i class="material-icons" id="wishlist-icon">favorite_border</i>
            </button>
          </div>

          <!-- Acordeón Descripción -->
          <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
            <button class="accordion-button collapsed w-full flex justify-between items-center p-4 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
              <span class="font-bold text-secondary uppercase text-sm">Descripción</span>
              <i class="material-icons accordion-icon">expand_more</i>
            </button>
            <div class="accordion-content">
              <div class="p-4 bg-white border-t border-gray-200 text-sm text-gray-600">
                <p class="leading-relaxed">
                  {product.description || product.shortDescription || 'Sin descripción disponible.'}
                </p>
              </div>
            </div>
          </div>

          <!-- Acordeón Características -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button class="accordion-button collapsed w-full flex justify-between items-center p-4 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
              <span class="font-bold text-secondary uppercase text-sm">Características</span>
              <i class="material-icons accordion-icon">expand_more</i>
            </button>
            <div class="accordion-content">
              <div class="p-4 bg-white border-t border-gray-200 text-sm text-gray-600 space-y-2">
              {product.sku && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>SKU:</span>
                  <span class="font-medium text-secondary">{product.sku}</span>
                </div>
              )}
              {product.brand && (
                <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                  <span>Marca:</span>
                  <div class="flex items-center gap-2">
                    {product.brand.logoUrl && (
                      <img src={product.brand.logoUrl} alt={product.brand.name} class="h-4 w-auto object-contain" />
                    )}
                    <span class="font-medium text-secondary">{product.brand.name}</span>
                  </div>
                </div>
              )}
              {product.color && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Color:</span>
                  <span class="font-medium text-secondary">{product.color}</span>
                </div>
              )}
              {product.category && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Categoría:</span>
                  <span class="font-medium text-secondary">{product.category.name}</span>
                </div>
              )}
              {product.sportType && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Deporte:</span>
                  <span class="font-medium text-secondary">{product.sportType}</span>
                </div>
              )}
              {product.isCollectible && product.collectionType && (
                <div class="flex justify-between border-b border-gray-100 pb-2">
                  <span>Colección:</span>
                  <span class="font-medium text-secondary">{product.collectionType}</span>
                </div>
              )}
              </div>
            </div>
          </div>

          <!-- Beneficios -->
          <div class="mt-8 grid grid-cols-3 gap-3 text-center">
            <div class="bg-gray-500 rounded-lg p-4 shadow-sm flex flex-col items-center gap-2">
              <i class="material-icons text-white text-2xl">local_shipping</i>
              <p class="text-xs text-white font-bold">Envío gratis +50€</p>
            </div>
            <div class="bg-gray-500 rounded-lg p-4 shadow-sm flex flex-col items-center gap-2">
              <i class="material-icons text-white text-2xl">verified_user</i>
              <p class="text-xs text-white font-bold">Compra segura</p>
            </div>
            <div class="bg-gray-500 rounded-lg p-4 shadow-sm flex flex-col items-center gap-2">
              <i class="material-icons text-white text-2xl">sync</i>
              <p class="text-xs text-white font-bold">Devolución 30 días</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Reseñas de Clientes -->
      <ProductReviews productId={product.id} />

      <!-- Productos Relacionados -->
      {relatedProducts.length > 0 && (
        <section class="mt-16 border-t border-gray-200 pt-12">
          <h2 class="text-3xl font-display font-extrabold uppercase italic text-secondary mb-8 relative inline-block">
            Productos Relacionados
            <span class="absolute bottom-0 left-0 w-[3ch] h-1 bg-primary"></span>
          </h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {relatedProducts.map((relProduct) => {
              const relPrice = typeof relProduct.price === 'string' ? parseFloat(relProduct.price) : relProduct.price;
              const relCompareAtPrice = relProduct.compareAtPrice
                ? (typeof relProduct.compareAtPrice === 'string' ? parseFloat(relProduct.compareAtPrice) : relProduct.compareAtPrice)
                : null;
              const relHasDiscount = relCompareAtPrice && relCompareAtPrice > relPrice;
              const relDiscountPercent = relHasDiscount ? Math.round(((relCompareAtPrice - relPrice) / relCompareAtPrice) * 100) : 0;
              const relImage = relProduct.thumbnailUrl || (relProduct.images && relProduct.images[0]) || '/placeholder.jpg';

              return (
                <a href={`/producto/${relProduct.slug}`} class="group relative bg-background-light rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300">
                  <div class="aspect-[4/5] bg-white overflow-hidden relative">
                    <img class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-500" src={relImage} alt={relProduct.name} />

                    {relHasDiscount && (
                      <div class="absolute top-2 right-2 bg-accent text-white text-xs font-bold px-2 py-1 rounded">
                        -{relDiscountPercent}%
                      </div>
                    )}
                    {relProduct.isNew && !relHasDiscount && (
                      <div class="absolute top-2 right-2 bg-primary text-black text-xs font-bold px-2 py-1 rounded">
                        NUEVO
                      </div>
                    )}
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-bold text-secondary mb-1 line-clamp-2">{relProduct.name}</h3>
                    {relProduct.category && (
                      <p class="text-sm text-gray-500 mb-2">{relProduct.category.name}</p>
                    )}
                    <div class="flex justify-between items-center">
                      <p class="text-lg font-bold text-secondary">{relPrice.toFixed(2)}€</p>
                      {relHasDiscount && (
                        <p class="text-sm text-gray-400 line-through">{relCompareAtPrice!.toFixed(2)}€</p>
                      )}
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )}
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Cambio de imagen principal al hacer click en thumbnail
  const thumbnails = document.querySelectorAll('.thumbnail');
  const mainImage = document.getElementById('main-image') as HTMLImageElement;

  thumbnails.forEach((thumb) => {
    thumb.addEventListener('click', () => {
      const newImage = thumb.getAttribute('data-image');
      if (newImage && mainImage) {
        mainImage.src = newImage;

        // Actualizar border de thumbnails
        thumbnails.forEach((t) => {
          t.classList.remove('border-primary');
          t.classList.add('border-gray-200');
        });
        thumb.classList.remove('border-gray-200');
        thumb.classList.add('border-primary');
      }
    });
  });

  // Contador de cantidad
  const quantityInput = document.querySelector('input[type="number"]') as HTMLInputElement;
  const decreaseBtn = document.querySelector('[aria-label="Disminuir cantidad"]');
  const increaseBtn = document.querySelector('[aria-label="Aumentar cantidad"]');

  decreaseBtn?.addEventListener('click', () => {
    const currentValue = parseInt(quantityInput.value);
    if (currentValue > 1) {
      quantityInput.value = (currentValue - 1).toString();
    }
  });

  increaseBtn?.addEventListener('click', () => {
    const currentValue = parseInt(quantityInput.value);
    quantityInput.value = (currentValue + 1).toString();
  });

  // Acordeones (múltiples)
  const accordionButtons = document.querySelectorAll('.accordion-button');

  accordionButtons.forEach((button) => {
    button.addEventListener('click', () => {
      // Solo alternar collapsed - el CSS hace el resto
      button.classList.toggle('collapsed');
    });
  });

  // Añadir al carrito y favoritos
  import { addToCart } from '@/lib/cart';
  import { addToWishlist, removeFromWishlist, isInWishlist } from '@/lib/wishlist';
  import { toastSuccess, toastError } from '@/lib/toast';

  const addToCartBtn = document.getElementById('add-to-cart-btn') as HTMLButtonElement;
  const cartIcon = document.getElementById('cart-icon');
  const cartBtnText = document.getElementById('cart-btn-text');

  // Variables para variantes seleccionadas
  let selectedSize: string | null = null;
  let selectedColor: string | null = null;
  let selectedVariant: any = null;

  // Cargar datos de variantes
  const variantsDataEl = document.getElementById('variants-data');
  const variants: any[] = variantsDataEl ? JSON.parse(variantsDataEl.textContent || '[]') : [];
  const hasVariants = variants.length > 0;

  // Verificar si realmente hay variantes que requieren selección
  const hasSizeOptions = variants.some(v => v.size);
  const hasColorOptions = variants.some(v => v.color);
  const needsVariantSelection = hasVariants && (hasSizeOptions || hasColorOptions);

  // Elementos de variantes
  const sizeOptions = document.querySelectorAll('.size-option');
  const colorOptions = document.querySelectorAll('.color-option');
  const selectedColorName = document.getElementById('selected-color-name');
  const variantStockEl = document.getElementById('variant-stock');
  const variantStockCount = document.getElementById('variant-stock-count');

  // Función para encontrar variante seleccionada
  function findSelectedVariant() {
    if (!hasVariants) return null;

    return variants.find(v => {
      const sizeMatch = !selectedSize || v.size === selectedSize;
      const colorMatch = !selectedColor || v.color === selectedColor;
      return sizeMatch && colorMatch;
    });
  }

  // Función para actualizar UI según selección
  function updateVariantUI() {
    selectedVariant = findSelectedVariant();

    // Actualizar stock mostrado
    if (variantStockEl && variantStockCount && selectedVariant) {
      variantStockEl.classList.remove('hidden');
      variantStockCount.textContent = selectedVariant.stock > 0
        ? `${selectedVariant.stock} unidades`
        : 'Agotado';
      variantStockCount.className = selectedVariant.stock > 0
        ? 'font-medium text-green-600'
        : 'font-medium text-red-600';
    }

    // Actualizar botón
    if (needsVariantSelection && addToCartBtn) {
      const needsSize = hasSizeOptions && !selectedSize;
      const needsColor = hasColorOptions && !selectedColor;

      if (needsSize || needsColor) {
        addToCartBtn.disabled = true;
        if (cartBtnText) cartBtnText.textContent = 'Selecciona opciones';
      } else if (selectedVariant && selectedVariant.stock === 0) {
        addToCartBtn.disabled = true;
        if (cartBtnText) cartBtnText.textContent = 'Agotado';
      } else {
        addToCartBtn.disabled = false;
        if (cartBtnText) cartBtnText.textContent = 'Añadir al Carrito';
      }
    }

    // Actualizar disponibilidad de colores según talla
    if (selectedSize) {
      colorOptions.forEach((btn) => {
        const color = (btn as HTMLButtonElement).dataset.color;
        const variant = variants.find(v => v.size === selectedSize && v.color === color);
        if (variant && variant.stock > 0) {
          (btn as HTMLButtonElement).disabled = false;
          btn.classList.remove('opacity-30', 'cursor-not-allowed');
        } else if (variant) {
          (btn as HTMLButtonElement).disabled = true;
          btn.classList.add('opacity-30', 'cursor-not-allowed');
        }
      });
    }

    // Actualizar disponibilidad de tallas según color
    if (selectedColor) {
      sizeOptions.forEach((btn) => {
        const size = (btn as HTMLButtonElement).dataset.size;
        const variant = variants.find(v => v.color === selectedColor && v.size === size);
        if (variant && variant.stock > 0) {
          (btn as HTMLButtonElement).disabled = false;
          btn.classList.remove('border-gray-200', 'text-gray-300', 'cursor-not-allowed', 'line-through');
          btn.classList.add('border-gray-300');
        } else if (variant) {
          (btn as HTMLButtonElement).disabled = true;
          btn.classList.add('border-gray-200', 'text-gray-300', 'cursor-not-allowed', 'line-through');
          btn.classList.remove('border-gray-300');
        }
      });
    }
  }

  // Event listeners para tallas
  sizeOptions.forEach((btn) => {
    btn.addEventListener('click', () => {
      if ((btn as HTMLButtonElement).disabled) return;

      sizeOptions.forEach(b => b.classList.remove('border-secondary', 'bg-secondary', 'text-white'));
      btn.classList.add('border-secondary', 'bg-secondary', 'text-white');
      selectedSize = (btn as HTMLButtonElement).dataset.size || null;
      updateVariantUI();
    });
  });

  // Event listeners para colores
  colorOptions.forEach((btn) => {
    btn.addEventListener('click', () => {
      if ((btn as HTMLButtonElement).disabled) return;

      colorOptions.forEach(b => b.classList.remove('ring-2', 'ring-secondary', 'ring-offset-2'));
      btn.classList.add('ring-2', 'ring-secondary', 'ring-offset-2');
      selectedColor = (btn as HTMLButtonElement).dataset.color || null;
      if (selectedColorName) selectedColorName.textContent = selectedColor || '';
      updateVariantUI();
    });
  });

  // Debug
  console.log('Variantes debug:', {
    hasVariants,
    variantsCount: variants.length,
    hasSizeOptions,
    hasColorOptions,
    needsVariantSelection
  });

  // Inicializar UI si hay variantes que requieren selección
  if (needsVariantSelection) {
    updateVariantUI();
  }

  // Botón de favoritos
  const wishlistBtn = document.getElementById('wishlist-btn') as HTMLButtonElement;
  const wishlistIcon = document.getElementById('wishlist-icon');

  if (wishlistBtn) {
    const productId = wishlistBtn.dataset.productId || '';

    // Inicializar estado del botón
    if (isInWishlist(productId)) {
      wishlistIcon!.textContent = 'favorite';
      wishlistBtn.classList.add('text-red-500', 'border-red-500');
    }

    wishlistBtn.addEventListener('click', () => {
      const productId = wishlistBtn.dataset.productId || '';
      const productName = wishlistBtn.dataset.productName || '';
      const productSlug = wishlistBtn.dataset.productSlug || '';
      const productPrice = parseFloat(wishlistBtn.dataset.productPrice || '0');
      const productImage = wishlistBtn.dataset.productImage || '';

      if (isInWishlist(productId)) {
        // Quitar de favoritos
        removeFromWishlist(productId);
        wishlistIcon!.textContent = 'favorite_border';
        wishlistBtn.classList.remove('text-red-500', 'border-red-500');
        toastSuccess('Eliminado de favoritos');
      } else {
        // Añadir a favoritos
        addToWishlist({
          productId,
          productName,
          productSlug,
          productImage,
          productPrice,
        });
        wishlistIcon!.textContent = 'favorite';
        wishlistBtn.classList.add('text-red-500', 'border-red-500');
        toastSuccess('Añadido a favoritos');
      }

      // Animación
      wishlistBtn.classList.add('scale-110');
      setTimeout(() => {
        wishlistBtn.classList.remove('scale-110');
      }, 200);
    });
  }

  addToCartBtn?.addEventListener('click', () => {
    const productId = addToCartBtn.dataset.productId;
    const productName = addToCartBtn.dataset.productName || '';
    const productSlug = addToCartBtn.dataset.productSlug || '';
    const productPrice = parseFloat(addToCartBtn.dataset.productPrice || '0');
    const productImage = addToCartBtn.dataset.productImage || '';
    const productStock = parseInt(addToCartBtn.dataset.productStock || '0');

    // Validar variantes si aplica
    if (needsVariantSelection) {
      const needsSize = hasSizeOptions && !selectedSize;
      const needsColor = hasColorOptions && !selectedColor;

      if (needsSize || needsColor) {
        toastError('Por favor selecciona todas las opciones');
        return;
      }

      if (!selectedVariant || selectedVariant.stock === 0) {
        toastError('Esta combinación no está disponible');
        return;
      }
    }

    if (!productId || (!needsVariantSelection && productStock === 0)) return;

    // Obtener cantidad seleccionada
    const quantityInput = document.querySelector('input[type="number"]') as HTMLInputElement;
    const quantity = parseInt(quantityInput?.value || '1');

    // Determinar precio (variante o producto)
    // Si la variante tiene precio, usarlo; si no, usar el precio del producto
    const variantPrice = selectedVariant?.price ? parseFloat(selectedVariant.price) : null;
    const finalPrice = variantPrice || productPrice;

    // Crear nombre con variante
    let finalName = productName;
    if (selectedSize || selectedColor) {
      const variantParts = [selectedSize, selectedColor].filter(Boolean);
      finalName = `${productName} (${variantParts.join(' - ')})`;
    }

    // Crear ID único para la variante
    const cartItemId = selectedVariant
      ? `${productId}-${selectedVariant.id}`
      : productId;

    // Crear objeto del producto para el carrito
    const cartItem = {
      productId: cartItemId,
      productName: finalName,
      productSlug: productSlug,
      productImage: selectedVariant?.imageUrl || productImage,
      quantity: quantity,
      unitPrice: finalPrice,
    };

    // Debug antes de añadir
    console.log('Añadiendo al carrito:', cartItem);

    // Añadir al carrito
    addToCart(cartItem);

    // Mostrar toast
    toastSuccess(`${finalName} añadido al carrito`);

    // Feedback visual en botón
    addToCartBtn.classList.add('scale-95');
    if (cartIcon) cartIcon.textContent = 'check';
    if (cartBtnText) cartBtnText.textContent = '¡Añadido!';

    setTimeout(() => {
      addToCartBtn.classList.remove('scale-95');
      if (cartIcon) cartIcon.textContent = 'shopping_bag';
      if (cartBtnText) cartBtnText.textContent = 'Añadir al Carrito';
    }, 1500);
  });
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .accordion-button:not(.collapsed) + .accordion-content {
    max-height: 500px;
  }

  .accordion-icon {
    transition: transform 0.3s ease;
  }

  .accordion-button:not(.collapsed) .accordion-icon {
    transform: rotate(180deg);
  }
</style>
