---
import Layout from '@/layouts/Layout.astro';
import Footer from '@/components/Footer.astro';

// Los datos del carrito se cargan desde localStorage en el cliente
// El servidor solo renderiza la estructura

const shippingMethods = [
  {
    id: 'pickup',
    name: 'Recogida en Tienda (Gratis)',
    description: 'Recoge tu pedido en nuestra tienda de Carcaixent',
    price: 0,
    recommended: true,
    isPickup: true
  },
  {
    id: 'standard',
    name: 'Envío Estándar (3-5 días)',
    description: 'Entrega en 3-5 días laborables',
    price: 4.99,
    recommended: false,
    isPickup: false
  },
  {
    id: 'express',
    name: 'Envío Express (24-48h)',
    description: 'Recíbelo en 1-2 días',
    price: 7.90,
    recommended: false,
    isPickup: false
  }
];

const paymentMethods = [
  {
    id: 'CASH',
    name: 'Pago en Tienda',
    description: 'Paga cuando recojas tu pedido',
    icon: 'store',
    forPickupOnly: true
  },
  {
    id: 'TRANSFER',
    name: 'Transferencia Bancaria',
    description: 'Te enviaremos los datos por email',
    icon: 'account_balance',
    forPickupOnly: false
  }
];

const storeAddress = {
  address: 'C/ San Pascual, 19',
  city: 'Vila-real',
  postalCode: '12540',
  province: 'Castellón',
  country: 'España'
};
---

<Layout title="Checkout - Deportes y Juguetes Eva" description="Finaliza tu compra">
  <!-- Header Simplificado -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <a href="/" class="flex items-center gap-3">
          <img src="/logo.png" alt="EVA" class="h-20 md:h-24" />
        </a>
        <a href="/" class="text-sm text-gray-600 hover:text-secondary transition-colors flex items-center gap-1">
          <i class="material-icons text-sm">arrow_back</i>
          Volver a la tienda
        </a>
      </div>
    </div>
  </header>

  <main class="bg-background-light min-h-screen">
    <div class="container mx-auto px-4 py-8 lg:py-12">
      <!-- Indicador de Progreso -->
      <nav aria-label="Progress" class="mb-12">
        <ol class="flex items-center justify-center space-x-2 sm:space-x-8 lg:space-x-12" role="list">
          <!-- Paso 1 - Activo -->
          <li class="flex items-center text-green-600">
            <span class="flex items-center justify-center w-8 h-8 border-2 border-green-600 rounded-full bg-green-600 text-white font-bold">1</span>
            <span class="ml-3 font-display font-bold text-secondary hidden sm:block">Envío</span>
          </li>

          <li class="flex items-center text-gray-400">
            <i class="material-icons text-xl mx-2">chevron_right</i>
          </li>

          <!-- Paso 2 -->
          <li class="flex items-center text-gray-400 group">
            <span class="flex items-center justify-center w-8 h-8 border-2 border-gray-200 rounded-full group-hover:border-secondary transition-colors font-medium">2</span>
            <span class="ml-3 font-display font-medium group-hover:text-secondary transition-colors hidden sm:block">Pago</span>
          </li>

          <li class="flex items-center text-gray-400">
            <i class="material-icons text-xl mx-2">chevron_right</i>
          </li>

          <!-- Paso 3 -->
          <li class="flex items-center text-gray-400 group">
            <span class="flex items-center justify-center w-8 h-8 border-2 border-gray-200 rounded-full group-hover:border-secondary transition-colors font-medium">3</span>
            <span class="ml-3 font-display font-medium group-hover:text-secondary transition-colors hidden sm:block">Confirmación</span>
          </li>
        </ol>
      </nav>

      <div class="grid lg:grid-cols-12 gap-8">
        <!-- Formulario -->
        <div class="lg:col-span-7">
          <form id="checkout-form" class="space-y-8">
            <!-- Información de Contacto -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-display font-bold text-secondary">Información de Contacto</h2>
                <a href="/login" class="text-sm text-secondary font-semibold hover:underline">Inicia Sesión</a>
              </div>

              <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="email">Correo electrónico</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="email"
                    type="email"
                    placeholder="tu@email.com"
                    required
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="first-name">Nombre</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="first-name"
                    type="text"
                    required
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="last-name">Apellidos</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="last-name"
                    type="text"
                    required
                  />
                </div>

                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="phone">Teléfono</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="phone"
                    type="tel"
                    placeholder="+34 600 000 000"
                    required
                  />
                </div>

                <div class="sm:col-span-2 flex items-start">
                  <input class="h-4 w-4 rounded border-gray-300 text-secondary focus:ring-secondary mt-0.5" id="newsletter" type="checkbox" />
                  <label class="ml-2 text-sm text-gray-600" for="newsletter">
                    Quiero recibir ofertas exclusivas y novedades por email
                  </label>
                </div>
              </div>
            </section>

            <!-- Dirección de Envío (se oculta si es recogida en tienda) -->
            <section id="shipping-address-section" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
              <h2 class="text-xl font-display font-bold text-secondary mb-6">Dirección de Envío</h2>

              <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="address">Dirección</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="address"
                    placeholder="Calle, número, piso..."
                    type="text"
                  />
                </div>

                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="apartment">Apartamento, suite, etc. (opcional)</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="apartment"
                    type="text"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="city">Ciudad</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="city"
                    type="text"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="postal-code">Código Postal</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="postal-code"
                    type="text"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="province">Provincia</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-3"
                    id="province"
                    type="text"
                  />
                </div>
              </div>
            </section>

            <!-- Método de Envío -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h2 class="text-xl font-display font-bold text-secondary mb-6">Método de Envío</h2>

              <div class="space-y-4">
                {shippingMethods.map((method) => (
                  <label class={`shipping-option relative flex cursor-pointer rounded-lg border p-4 shadow-sm focus:outline-none transition-all ${method.recommended ? 'border-green-600 bg-green-50 ring-1 ring-green-600' : 'border-gray-200 hover:border-gray-300'}`} data-price={method.price} data-pickup={method.isPickup}>
                    <input
                      checked={method.recommended}
                      class="sr-only"
                      name="shipping-method"
                      type="radio"
                      value={method.id}
                    />
                    <span class="flex flex-1">
                      <span class="flex flex-col">
                        <span class="block text-sm font-bold text-secondary flex items-center gap-2">
                          {method.isPickup && <i class="material-icons text-lg">store</i>}
                          {!method.isPickup && <i class="material-icons text-lg">local_shipping</i>}
                          {method.name}
                        </span>
                        <span class="mt-1 flex items-center text-sm text-gray-500">{method.description}</span>
                        {method.recommended && (
                          <span class="mt-2 text-xs font-semibold text-green-600">Recomendado</span>
                        )}
                      </span>
                    </span>
                    <span class="mt-0.5 text-sm font-bold text-secondary">{method.price === 0 ? 'Gratis' : `${method.price.toFixed(2)}€`}</span>

                    {method.recommended && (
                      <>
                        <span aria-hidden="true" class="pointer-events-none absolute -inset-px rounded-lg border-2 border-green-600"></span>
                        <span class="absolute top-4 right-4 h-4 w-4 rounded-full border border-green-600 bg-green-600">
                          <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white"></span>
                        </span>
                      </>
                    )}

                    {!method.recommended && (
                      <span class="absolute top-4 right-4 h-4 w-4 rounded-full border border-gray-300"></span>
                    )}
                  </label>
                ))}
              </div>

              <!-- Info de dirección de tienda para recogida -->
              <div id="pickup-address" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm font-bold text-green-800 mb-2">Dirección de recogida:</p>
                <address class="not-italic text-sm text-green-700">
                  <p>Deportes y Juguetes Eva</p>
                  <p>C/ San Pascual, 19</p>
                  <p>12540 Vila-real (Castellón)</p>
                </address>
                <p class="text-xs text-green-600 mt-2">
                  <i class="material-icons text-xs align-middle">schedule</i>
                  Horario: L-V 10:00-13:30 y 17:00-20:30, S 10:00-13:30
                </p>
              </div>
            </section>

            <!-- Método de Pago -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h2 class="text-xl font-display font-bold text-secondary mb-6">Método de Pago</h2>

              <div class="space-y-4" id="payment-methods">
                {paymentMethods.map((method, index) => (
                  <label class={`payment-option relative flex cursor-pointer rounded-lg border p-4 shadow-sm focus:outline-none transition-all ${index === 0 ? 'border-green-600 bg-green-50 ring-1 ring-green-600' : 'border-gray-200 hover:border-gray-300'}`} data-method={method.id} data-pickup-only={method.forPickupOnly}>
                    <input
                      checked={index === 0}
                      class="sr-only"
                      name="payment-method"
                      type="radio"
                      value={method.id}
                    />
                    <span class="flex flex-1 items-center gap-4">
                      <i class={`material-icons text-2xl ${index === 0 ? 'text-green-600' : 'text-gray-400'}`}>{method.icon}</i>
                      <span class="flex flex-col">
                        <span class="block text-sm font-bold text-secondary">{method.name}</span>
                        <span class="mt-1 text-sm text-gray-500">{method.description}</span>
                      </span>
                    </span>
                    <span class={`h-5 w-5 rounded-full border-2 flex items-center justify-center ${index === 0 ? 'border-green-600 bg-green-600' : 'border-gray-300'}`}>
                      {index === 0 && <span class="w-2 h-2 rounded-full bg-white"></span>}
                    </span>
                  </label>
                ))}
              </div>

              <!-- Información adicional según método -->
              <div id="transfer-info" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <p class="text-sm text-blue-800">
                  <i class="material-icons text-sm align-middle mr-1">info</i>
                  Una vez confirmes el pedido, te enviaremos los datos bancarios a tu email. El pedido se preparará cuando recibamos el pago.
                </p>
              </div>

              <div id="cash-info" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800">
                  <i class="material-icons text-sm align-middle mr-1">store</i>
                  Podrás pagar en efectivo o con tarjeta cuando recojas tu pedido en la tienda.
                </p>
              </div>
            </section>

            <!-- Resumen antes de confirmar -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <p class="text-sm text-yellow-800">
                <i class="material-icons text-sm align-middle mr-1">info</i>
                Al confirmar el pedido, recibirás un email con los detalles y las instrucciones según el método de pago seleccionado.
              </p>
            </div>

            <!-- Botón Confirmar Pedido -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-secondary hover:bg-black text-white font-black py-4 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 uppercase tracking-wide flex items-center justify-center gap-2"
            >
              <span id="submit-text">Confirmar Pedido</span>
              <div id="submit-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
            </button>
          </form>
        </div>

        <!-- Resumen del Pedido -->
        <div class="lg:col-span-5">
          <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden sticky top-24">
            <!-- Header -->
            <div class="p-6 bg-gray-50 border-b border-gray-200">
              <h2 class="text-lg font-display font-bold text-secondary">Resumen del Pedido</h2>
              <p class="text-sm text-gray-600 mt-1" id="cart-count">Cargando carrito...</p>
            </div>

            <!-- Lista de productos -->
            <div class="p-6 space-y-6 max-h-96 overflow-y-auto" id="cart-items">
              <div class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-secondary mx-auto"></div>
                <p class="text-gray-500 mt-2 text-sm">Cargando productos...</p>
              </div>
            </div>

            <!-- Cupón de descuento -->
            <div class="px-6 py-4 bg-gray-50 border-t border-b border-gray-200">
              <form id="coupon-form" class="flex space-x-2">
                <input
                  class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm py-2 px-3"
                  placeholder="Código de descuento"
                  type="text"
                  id="coupon-code"
                />
                <button
                  class="bg-secondary text-white font-medium text-sm px-4 py-2 rounded hover:bg-black transition-colors whitespace-nowrap"
                  type="submit"
                >
                  Aplicar
                </button>
              </form>
              <p id="coupon-message" class="text-sm mt-2 hidden"></p>
            </div>

            <!-- Totales -->
            <div class="p-6 bg-white space-y-4">
              <div class="flex items-center justify-between text-sm text-gray-600">
                <p>Subtotal</p>
                <p class="font-medium text-secondary" id="subtotal">0.00 €</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-600">
                <p>Envío</p>
                <p class="font-medium text-secondary" id="shipping">5.90 €</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-600" id="discount-row" style="display: none;">
                <p>Descuento</p>
                <p class="font-medium text-green-600" id="discount">-0.00 €</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-600">
                <p>IVA incluido (21%)</p>
                <p class="font-medium text-secondary" id="tax">0.00 €</p>
              </div>
              <div class="border-t border-gray-200 pt-4 flex items-center justify-between">
                <p class="text-base font-bold text-secondary font-display uppercase">Total</p>
                <p class="text-2xl font-black text-secondary font-display" id="total">0.00 €</p>
              </div>
            </div>

            <!-- Footer con iconos -->
            <div class="bg-gray-50 p-4 border-t border-gray-200 grid grid-cols-3 gap-2 text-center text-xs text-gray-600">
              <div class="flex flex-col items-center gap-1">
                <i class="material-icons text-lg text-secondary">lock</i>
                <span>Pago Seguro</span>
              </div>
              <div class="flex flex-col items-center gap-1">
                <i class="material-icons text-lg text-secondary">local_shipping</i>
                <span>Envío Rápido</span>
              </div>
              <div class="flex flex-col items-center gap-1">
                <i class="material-icons text-lg text-secondary">verified</i>
                <span>Garantía Oficial</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  interface CartItem {
    productId: string;
    productName: string;
    productSlug: string;
    productImage: string;
    quantity: number;
    unitPrice: number;
    totalPrice: number;
  }

  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';

  // Dirección de la tienda para recogida
  const storeAddress = {
    address: 'C/ San Pascual, 19',
    city: 'Vila-real',
    postalCode: '12540',
    province: 'Castellón',
    country: 'España'
  };

  // Cargar carrito desde localStorage (key: eva_cart)
  const loadCart = (): CartItem[] => {
    try {
      const cart = localStorage.getItem('eva_cart');
      return cart ? JSON.parse(cart) : [];
    } catch {
      return [];
    }
  };

  // Limpiar carrito
  const clearCart = () => {
    localStorage.removeItem('eva_cart');
    window.dispatchEvent(new CustomEvent('cart-updated'));
  };

  // Calcular totales
  // NOTA: Los precios de los productos YA INCLUYEN IVA (21%)
  // En el checkout desglosamos: precioConIVA = base + IVA => base = precioConIVA / 1.21
  const calculateTotals = (items: CartItem[], shippingCost: number, discountPercent: number = 0) => {
    const totalConIVA = items.reduce((sum, item) => {
      // Usar totalPrice si existe, si no calcular desde unitPrice * quantity
      const itemTotal = item.totalPrice || (item.unitPrice || 0) * (item.quantity || 1);
      return sum + (isNaN(itemTotal) ? 0 : itemTotal);
    }, 0);

    // Aplicar descuento al total con IVA
    const discountAmount = totalConIVA * (discountPercent / 100);
    const totalConIVADescontado = totalConIVA - discountAmount;

    // Extraer base imponible e IVA del precio (que ya incluye IVA)
    const subtotal = totalConIVADescontado / 1.21;  // Base imponible sin IVA
    const tax = totalConIVADescontado - subtotal;    // IVA incluido

    // Total = productos (con IVA ya incluido) + envío
    const total = totalConIVADescontado + shippingCost;

    return { subtotal, discountAmount, tax, total };
  };

  // Renderizar items del carrito
  const renderCartItems = (items: CartItem[]) => {
    const container = document.getElementById('cart-items');
    const countEl = document.getElementById('cart-count');

    if (!container) return;

    if (items.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8">
          <i class="material-icons text-4xl text-gray-300 mb-2">shopping_cart</i>
          <p class="text-gray-500">Tu carrito está vacío</p>
          <a href="/" class="text-secondary font-semibold hover:underline text-sm mt-2 inline-block">Volver a la tienda</a>
        </div>
      `;
      if (countEl) countEl.textContent = '0 artículos en tu carrito';
      return;
    }

    const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
    if (countEl) countEl.textContent = `${totalItems} artículo${totalItems !== 1 ? 's' : ''} en tu carrito`;

    container.innerHTML = items.map(item => {
      const unitPrice = item.unitPrice || 0;
      const displayPrice = typeof unitPrice === 'number' && !isNaN(unitPrice) ? unitPrice.toFixed(2) : '0.00';
      return `
      <div class="flex items-start space-x-4">
        <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border border-gray-200 bg-white">
          <img class="h-full w-full object-cover object-center" src="${item.productImage || '/placeholder.jpg'}" alt="${item.productName}" />
        </div>
        <div class="flex-1 min-w-0">
          <h3 class="text-sm font-medium text-secondary font-display">${item.productName}</h3>
          <div class="mt-2 flex items-center justify-between">
            <p class="text-sm font-medium text-secondary">${displayPrice} €</p>
            <div class="flex items-center text-gray-600 text-xs">Cant: ${item.quantity}</div>
          </div>
        </div>
      </div>
    `;
    }).join('');
  };

  // Actualizar totales en la UI
  const updateTotals = (items: CartItem[], shippingCost: number, discountPercent: number = 0) => {
    const { subtotal, discountAmount, tax, total } = calculateTotals(items, shippingCost, discountPercent);

    const subtotalEl = document.getElementById('subtotal');
    const shippingEl = document.getElementById('shipping');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');
    const discountRow = document.getElementById('discount-row');
    const discountEl = document.getElementById('discount');

    if (subtotalEl) subtotalEl.textContent = `${subtotal.toFixed(2)} €`;
    if (shippingEl) shippingEl.textContent = shippingCost === 0 ? 'Gratis' : `${shippingCost.toFixed(2)} €`;
    if (taxEl) taxEl.textContent = `${tax.toFixed(2)} €`;
    if (totalEl) totalEl.textContent = `${total.toFixed(2)} €`;

    if (discountRow && discountEl) {
      if (discountPercent > 0) {
        discountRow.style.display = 'flex';
        discountEl.textContent = `-${discountAmount.toFixed(2)} €`;
      } else {
        discountRow.style.display = 'none';
      }
    }
  };

  // Variables globales
  let currentShippingCost = 0; // Recogida en tienda por defecto
  let currentDiscountPercent = 0;
  let currentPaymentMethod = 'CASH';
  let isPickup = true; // Recogida en tienda por defecto
  let cartItems: CartItem[] = [];

  // Función para actualizar visibilidad de secciones según método de envío
  const updateShippingUI = (pickup: boolean) => {
    isPickup = pickup;
    const addressSection = document.getElementById('shipping-address-section');
    const pickupAddressInfo = document.getElementById('pickup-address');
    const paymentOptions = document.querySelectorAll('.payment-option');

    if (pickup) {
      addressSection?.classList.add('hidden');
      pickupAddressInfo?.classList.remove('hidden');
      // Mostrar solo "Pago en Tienda" y "Transferencia"
      paymentOptions.forEach((opt) => {
        const el = opt as HTMLElement;
        el.classList.remove('hidden');
      });
      // Auto-seleccionar "Pago en Tienda"
      selectPaymentMethod('CASH');
    } else {
      addressSection?.classList.remove('hidden');
      pickupAddressInfo?.classList.add('hidden');
      // Ocultar "Pago en Tienda" si no es recogida
      paymentOptions.forEach((opt) => {
        const el = opt as HTMLElement;
        const forPickupOnly = el.dataset.pickupOnly === 'true';
        if (forPickupOnly) {
          el.classList.add('hidden');
        }
      });
      // Auto-seleccionar "Transferencia" si el actual es CASH
      if (currentPaymentMethod === 'CASH') {
        selectPaymentMethod('TRANSFER');
      }
    }
  };

  // Función para seleccionar método de pago
  const selectPaymentMethod = (method: string) => {
    currentPaymentMethod = method;
    const paymentOptions = document.querySelectorAll('.payment-option');
    const transferInfo = document.getElementById('transfer-info');
    const cashInfo = document.getElementById('cash-info');

    paymentOptions.forEach((opt) => {
      const el = opt as HTMLElement;
      const radio = el.querySelector('input[type="radio"]') as HTMLInputElement;
      const icon = el.querySelector('i.material-icons');
      const circle = el.querySelector('.h-5.w-5.rounded-full');

      if (el.dataset.method === method) {
        el.classList.remove('border-gray-200');
        el.classList.add('border-green-600', 'bg-green-50', 'ring-1', 'ring-green-600');
        if (radio) radio.checked = true;
        if (icon) {
          icon.classList.remove('text-gray-400');
          icon.classList.add('text-green-600');
        }
        if (circle) {
          circle.classList.remove('border-gray-300');
          circle.classList.add('border-green-600', 'bg-green-600');
          if (!circle.querySelector('.w-2.h-2')) {
            const dot = document.createElement('span');
            dot.className = 'w-2 h-2 rounded-full bg-white';
            circle.appendChild(dot);
          }
        }
      } else {
        el.classList.remove('border-green-600', 'bg-green-50', 'ring-1', 'ring-green-600');
        el.classList.add('border-gray-200');
        if (radio) radio.checked = false;
        if (icon) {
          icon.classList.remove('text-green-600');
          icon.classList.add('text-gray-400');
        }
        if (circle) {
          circle.classList.remove('border-green-600', 'bg-green-600');
          circle.classList.add('border-gray-300');
          const dot = circle.querySelector('.w-2.h-2');
          dot?.remove();
        }
      }
    });

    // Mostrar info según método
    if (method === 'TRANSFER') {
      transferInfo?.classList.remove('hidden');
      cashInfo?.classList.add('hidden');
    } else {
      transferInfo?.classList.add('hidden');
      cashInfo?.classList.remove('hidden');
    }
  };

  // Inicializar
  document.addEventListener('DOMContentLoaded', () => {
    cartItems = loadCart();
    renderCartItems(cartItems);
    updateTotals(cartItems, currentShippingCost, currentDiscountPercent);

    // Inicializar UI (recogida en tienda por defecto)
    updateShippingUI(true);

    // Manejo de selección de método de envío
    const shippingOptions = document.querySelectorAll('.shipping-option');

    shippingOptions.forEach((option) => {
      option.addEventListener('click', () => {
        const el = option as HTMLElement;
        const price = parseFloat(el.dataset.price || '0');
        const pickup = el.dataset.pickup === 'true';
        currentShippingCost = price;

        // Actualizar estilos de shipping
        shippingOptions.forEach((opt) => {
          opt.classList.remove('border-green-600', 'bg-green-50', 'ring-1', 'ring-green-600');
          opt.classList.add('border-gray-200');

          const radioCircle = opt.querySelector('.absolute.top-4.right-4');
          if (radioCircle) {
            radioCircle.classList.remove('border-green-600', 'bg-green-600');
            radioCircle.classList.add('border-gray-300');
            const innerDot = radioCircle.querySelector('.w-2.h-2');
            innerDot?.remove();
          }
        });

        // Añadir estilos al seleccionado
        option.classList.remove('border-gray-200');
        option.classList.add('border-green-600', 'bg-green-50', 'ring-1', 'ring-green-600');

        const radioCircle = option.querySelector('.absolute.top-4.right-4');
        if (radioCircle) {
          radioCircle.classList.remove('border-gray-300');
          radioCircle.classList.add('border-green-600', 'bg-green-600');
          if (!radioCircle.querySelector('.w-2.h-2')) {
            const dot = document.createElement('span');
            dot.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white';
            radioCircle.appendChild(dot);
          }
        }

        // Actualizar UI según pickup
        updateShippingUI(pickup);

        // Actualizar totales
        updateTotals(cartItems, currentShippingCost, currentDiscountPercent);
      });
    });

    // Manejo de selección de método de pago
    const paymentOptions = document.querySelectorAll('.payment-option');
    paymentOptions.forEach((option) => {
      option.addEventListener('click', () => {
        const el = option as HTMLElement;
        if (!el.classList.contains('hidden')) {
          selectPaymentMethod(el.dataset.method || 'CASH');
        }
      });
    });

    // Manejo de cupones
    const couponForm = document.getElementById('coupon-form');
    const couponMessage = document.getElementById('coupon-message');

    couponForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const codeInput = document.getElementById('coupon-code') as HTMLInputElement;
      const code = codeInput?.value.trim();

      if (!code) return;

      try {
        const response = await fetch(`${API_URL}/coupons/validate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        const data = await response.json();

        if (couponMessage) {
          if (data.valid) {
            currentDiscountPercent = data.discount;
            couponMessage.textContent = `¡Cupón aplicado! ${data.discount}% de descuento`;
            couponMessage.className = 'text-sm mt-2 text-green-600';
            couponMessage.classList.remove('hidden');
            updateTotals(cartItems, currentShippingCost, currentDiscountPercent);
          } else {
            couponMessage.textContent = data.message || 'Cupón no válido';
            couponMessage.className = 'text-sm mt-2 text-red-600';
            couponMessage.classList.remove('hidden');
          }
        }
      } catch {
        if (couponMessage) {
          couponMessage.textContent = 'Error al validar el cupón';
          couponMessage.className = 'text-sm mt-2 text-red-600';
          couponMessage.classList.remove('hidden');
        }
      }
    });

    // Validación y envío del formulario
    const form = document.getElementById('checkout-form');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (cartItems.length === 0) {
        alert('Tu carrito está vacío');
        return;
      }

      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');

      // Recoger datos del formulario
      const email = (document.getElementById('email') as HTMLInputElement)?.value?.trim();
      const firstName = (document.getElementById('first-name') as HTMLInputElement)?.value?.trim();
      const lastName = (document.getElementById('last-name') as HTMLInputElement)?.value?.trim();
      const phone = (document.getElementById('phone') as HTMLInputElement)?.value?.trim();

      // Dirección: usar tienda si es recogida, sino los campos del formulario
      let shippingAddress, shippingCity, shippingPostalCode, shippingProvince;
      if (isPickup) {
        shippingAddress = storeAddress.address;
        shippingCity = storeAddress.city;
        shippingPostalCode = storeAddress.postalCode;
        shippingProvince = storeAddress.province;
      } else {
        shippingAddress = (document.getElementById('address') as HTMLInputElement)?.value?.trim();
        const apartment = (document.getElementById('apartment') as HTMLInputElement)?.value?.trim();
        if (apartment) shippingAddress += ', ' + apartment;
        shippingCity = (document.getElementById('city') as HTMLInputElement)?.value?.trim();
        shippingPostalCode = (document.getElementById('postal-code') as HTMLInputElement)?.value?.trim();
        shippingProvince = (document.getElementById('province') as HTMLInputElement)?.value?.trim();
      }

      // Validar campos requeridos
      if (!email || !firstName || !lastName || !phone) {
        alert('Por favor, completa todos los campos de contacto');
        return;
      }

      if (!isPickup && (!shippingAddress || !shippingCity || !shippingPostalCode)) {
        alert('Por favor, completa todos los campos de dirección');
        return;
      }

      // Mostrar spinner
      if (submitBtn) submitBtn.disabled = true;
      if (submitText) submitText.textContent = 'Procesando...';
      if (submitSpinner) submitSpinner.classList.remove('hidden');

      try {
        // Preparar datos para el API
        const orderData = {
          userEmail: email,
          userName: `${firstName} ${lastName}`,
          userPhone: phone,
          shippingAddress,
          shippingCity,
          shippingPostalCode,
          shippingProvince,
          shippingCountry: 'España',
          items: cartItems.map(item => ({
            productId: item.productId,
            quantity: item.quantity
          })),
          paymentMethod: currentPaymentMethod
        };

        // Llamar al API
        const response = await fetch(`${API_URL}/checkout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Limpiar carrito
          clearCart();

          // Redirigir a confirmación
          window.location.href = `/confirmacion?orderId=${result.order.id}`;
        } else {
          throw new Error(result.error || 'Error al crear el pedido');
        }
      } catch (error) {
        console.error('Error:', error);
        alert(error instanceof Error ? error.message : 'Error al procesar el pedido. Por favor, inténtalo de nuevo.');

        // Restaurar botón
        if (submitBtn) submitBtn.disabled = false;
        if (submitText) submitText.textContent = 'Confirmar Pedido';
        if (submitSpinner) submitSpinner.classList.add('hidden');
      }
    });
  });
</script>
