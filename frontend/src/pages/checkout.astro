---
import Layout from '@/layouts/Layout.astro';
import Footer from '@/components/Footer.astro';

// Mock order data
const orderItems = [
  {
    id: 1,
    name: 'Balón de Baloncesto Pro',
    variant: 'Talla 7 - Naranja',
    price: 29.99,
    quantity: 1,
    image: '/products/balon-basket.jpg'
  },
  {
    id: 2,
    name: 'Zapatillas Running X1',
    variant: 'Talla 42 - Negro',
    price: 89.99,
    quantity: 1,
    image: '/products/zapatillas.jpg'
  }
];

const subtotal = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
const shipping = 5.90;
const tax = subtotal * 0.21;
const total = subtotal + shipping + tax;

const shippingMethods = [
  {
    id: 'express',
    name: 'Envío Express (24h)',
    description: 'Recíbelo mañana',
    price: 5.90,
    recommended: true
  },
  {
    id: 'standard',
    name: 'Envío Estándar (3-5 días)',
    description: 'Entrega estimada: Lunes, 24 Oct',
    price: 0,
    recommended: false
  }
];
---

<Layout title="Checkout - Deportes y Juguetes Eva" description="Finaliza tu compra">
  <!-- Header Simplificado -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <a href="/" class="flex items-center gap-3">
          <img src="/logo.png" alt="EVA" class="h-12" />
        </a>
        <a href="/" class="text-sm text-gray-600 hover:text-primary transition-colors flex items-center gap-1">
          <i class="material-icons text-sm">arrow_back</i>
          Volver a la tienda
        </a>
      </div>
    </div>
  </header>

  <main class="bg-background-light min-h-screen">
    <div class="container mx-auto px-4 py-8 lg:py-12">
      <!-- Indicador de Progreso -->
      <nav aria-label="Progress" class="mb-12">
        <ol class="flex items-center justify-center space-x-2 sm:space-x-8 lg:space-x-12" role="list">
          <!-- Paso 1 - Activo -->
          <li class="flex items-center text-primary">
            <span class="flex items-center justify-center w-8 h-8 border-2 border-primary rounded-full bg-primary text-black font-bold">1</span>
            <span class="ml-3 font-display font-bold text-black hidden sm:block">Envío</span>
          </li>

          <li class="flex items-center text-gray-400">
            <i class="material-icons text-xl mx-2">chevron_right</i>
          </li>

          <!-- Paso 2 -->
          <li class="flex items-center text-gray-400 group">
            <span class="flex items-center justify-center w-8 h-8 border-2 border-gray-200 rounded-full group-hover:border-primary transition-colors font-medium">2</span>
            <span class="ml-3 font-display font-medium group-hover:text-primary transition-colors hidden sm:block">Pago</span>
          </li>

          <li class="flex items-center text-gray-400">
            <i class="material-icons text-xl mx-2">chevron_right</i>
          </li>

          <!-- Paso 3 -->
          <li class="flex items-center text-gray-400 group">
            <span class="flex items-center justify-center w-8 h-8 border-2 border-gray-200 rounded-full group-hover:border-primary transition-colors font-medium">3</span>
            <span class="ml-3 font-display font-medium group-hover:text-primary transition-colors hidden sm:block">Confirmación</span>
          </li>
        </ol>
      </nav>

      <div class="grid lg:grid-cols-12 gap-8">
        <!-- Formulario -->
        <div class="lg:col-span-7">
          <form class="space-y-8">
            <!-- Información de Contacto -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-display font-bold text-secondary">Información de Contacto</h2>
                <a href="/login" class="text-sm text-primary hover:underline">Inicia Sesión</a>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="email">Correo electrónico</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="email"
                    type="email"
                    placeholder="tu@email.com"
                    required
                  />
                </div>

                <div class="flex items-start">
                  <input class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary mt-0.5" id="newsletter" type="checkbox" />
                  <label class="ml-2 text-sm text-gray-600" for="newsletter">
                    Quiero recibir ofertas exclusivas y novedades por email
                  </label>
                </div>
              </div>
            </section>

            <!-- Dirección de Envío -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h2 class="text-xl font-display font-bold text-secondary mb-6">Dirección de Envío</h2>

              <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="first-name">Nombre</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="first-name"
                    type="text"
                    required
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="last-name">Apellidos</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="last-name"
                    type="text"
                    required
                  />
                </div>

                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="address">Dirección</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="address"
                    placeholder="Calle, número, piso..."
                    type="text"
                    required
                  />
                </div>

                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="apartment">Apartamento, suite, etc. (opcional)</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="apartment"
                    type="text"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="city">Ciudad</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="city"
                    type="text"
                    required
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="postal-code">Código Postal</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="postal-code"
                    type="text"
                    required
                  />
                </div>

                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="phone">Teléfono</label>
                  <input
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-3"
                    id="phone"
                    type="tel"
                    placeholder="+34 600 000 000"
                    required
                  />
                </div>
              </div>
            </section>

            <!-- Método de Envío -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h2 class="text-xl font-display font-bold text-secondary mb-6">Método de Envío</h2>

              <div class="space-y-4">
                {shippingMethods.map((method, index) => (
                  <label class={`shipping-option relative flex cursor-pointer rounded-lg border p-4 shadow-sm focus:outline-none transition-all ${method.recommended ? 'border-primary bg-primary/5 ring-1 ring-primary' : 'border-gray-200 hover:border-gray-300'}`}>
                    <input
                      checked={method.recommended}
                      class="sr-only"
                      name="shipping-method"
                      type="radio"
                      value={method.id}
                    />
                    <span class="flex flex-1">
                      <span class="flex flex-col">
                        <span class="block text-sm font-bold text-secondary">{method.name}</span>
                        <span class="mt-1 flex items-center text-sm text-gray-500">{method.description}</span>
                        {method.recommended && (
                          <span class="mt-2 text-xs font-semibold text-green-600">Recomendado</span>
                        )}
                      </span>
                    </span>
                    <span class="mt-0.5 text-sm font-bold text-secondary">{method.price === 0 ? 'Gratis' : `${method.price.toFixed(2)}€`}</span>

                    {method.recommended && (
                      <>
                        <span aria-hidden="true" class="pointer-events-none absolute -inset-px rounded-lg border-2 border-primary"></span>
                        <span class="absolute top-4 right-4 h-4 w-4 rounded-full border border-primary bg-primary">
                          <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-black"></span>
                        </span>
                      </>
                    )}

                    {!method.recommended && (
                      <span class="absolute top-4 right-4 h-4 w-4 rounded-full border border-gray-300"></span>
                    )}
                  </label>
                ))}
              </div>
            </section>

            <!-- Botón Continuar -->
            <button
              type="submit"
              class="w-full bg-primary hover:bg-yellow-400 text-black font-black py-4 px-6 rounded shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 uppercase tracking-wide"
            >
              Continuar al Pago
            </button>
          </form>
        </div>

        <!-- Resumen del Pedido -->
        <div class="lg:col-span-5">
          <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden sticky top-24">
            <!-- Header -->
            <div class="p-6 bg-gray-50 border-b border-gray-200">
              <h2 class="text-lg font-display font-bold text-black">Resumen del Pedido</h2>
              <p class="text-sm text-gray-600 mt-1">{orderItems.length} artículos en tu carrito</p>
            </div>

            <!-- Lista de productos -->
            <div class="p-6 space-y-6 max-h-96 overflow-y-auto">
              {orderItems.map((item) => (
                <div class="flex items-start space-x-4">
                  <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border border-gray-200 bg-white">
                    <img class="h-full w-full object-cover object-center" src={item.image} alt={item.name} />
                  </div>
                  <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-medium text-black font-display">{item.name}</h3>
                    <p class="text-sm text-gray-600 mt-1">{item.variant}</p>
                    <div class="mt-2 flex items-center justify-between">
                      <p class="text-sm font-medium text-black">{item.price.toFixed(2)} €</p>
                      <div class="flex items-center text-gray-600 text-xs">Cant: {item.quantity}</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <!-- Cupón de descuento -->
            <div class="px-6 py-4 bg-gray-50 border-t border-b border-gray-200">
              <form class="flex space-x-2">
                <input
                  class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3"
                  placeholder="Código de descuento"
                  type="text"
                />
                <button
                  class="bg-black text-white font-medium text-sm px-4 py-2 rounded hover:opacity-90 transition-opacity whitespace-nowrap"
                  type="submit"
                >
                  Aplicar
                </button>
              </form>
            </div>

            <!-- Totales -->
            <div class="p-6 bg-white space-y-4">
              <div class="flex items-center justify-between text-sm text-gray-600">
                <p>Subtotal</p>
                <p class="font-medium text-black">{subtotal.toFixed(2)} €</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-600">
                <p>Envío</p>
                <p class="font-medium text-black">{shipping.toFixed(2)} €</p>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-600">
                <p>Impuestos (21% IVA)</p>
                <p class="font-medium text-black">{tax.toFixed(2)} €</p>
              </div>
              <div class="border-t border-gray-200 pt-4 flex items-center justify-between">
                <p class="text-base font-bold text-black font-display uppercase">Total</p>
                <p class="text-2xl font-black text-primary font-display">{total.toFixed(2)} €</p>
              </div>
            </div>

            <!-- Footer con iconos -->
            <div class="bg-gray-50 p-4 border-t border-gray-200 grid grid-cols-3 gap-2 text-center text-xs text-gray-600">
              <div class="flex flex-col items-center gap-1">
                <i class="material-icons text-lg">lock</i>
                <span>Pago Seguro</span>
              </div>
              <div class="flex flex-col items-center gap-1">
                <i class="material-icons text-lg">local_shipping</i>
                <span>Envío Rápido</span>
              </div>
              <div class="flex flex-col items-center gap-1">
                <i class="material-icons text-lg">verified</i>
                <span>Garantía Oficial</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Manejo de selección de método de envío
  const shippingOptions = document.querySelectorAll('.shipping-option');

  shippingOptions.forEach((option) => {
    option.addEventListener('click', () => {
      // Remover clases de todos
      shippingOptions.forEach((opt) => {
        opt.classList.remove('border-primary', 'bg-primary/5', 'ring-1', 'ring-primary');
        opt.classList.add('border-gray-200');

        const radioCircle = opt.querySelector('.h-4.w-4.rounded-full');
        radioCircle?.classList.remove('border-primary', 'bg-primary');
        radioCircle?.classList.add('border-gray-300');

        const innerDot = opt.querySelector('.w-2.h-2.rounded-full');
        innerDot?.remove();
      });

      // Añadir clases al seleccionado
      option.classList.remove('border-gray-200');
      option.classList.add('border-primary', 'bg-primary/5', 'ring-1', 'ring-primary');

      const radioCircle = option.querySelector('.h-4.w-4.rounded-full');
      radioCircle?.classList.remove('border-gray-300');
      radioCircle?.classList.add('border-primary', 'bg-primary');

      // Añadir dot interior
      if (!option.querySelector('.w-2.h-2.rounded-full')) {
        const dot = document.createElement('span');
        dot.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-black';
        radioCircle?.appendChild(dot);
      }
    });
  });

  // Validación del formulario
  const form = document.querySelector('form');
  form?.addEventListener('submit', (e) => {
    e.preventDefault();

    // Validar campos requeridos
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach((field) => {
      const input = field as HTMLInputElement;
      if (!input.value.trim()) {
        isValid = false;
        input.classList.add('border-red-500');
      } else {
        input.classList.remove('border-red-500');
      }
    });

    if (isValid) {
      // En producción, aquí se enviaría al backend
      window.location.href = '/confirmacion';
    } else {
      alert('Por favor, completa todos los campos requeridos');
    }
  });
</script>
