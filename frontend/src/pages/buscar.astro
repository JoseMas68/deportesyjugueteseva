---
export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import ProductCard from '@/components/ProductCard.astro';
import { getProducts, getBrands, type Product } from '@/lib/api';

// Get query parameters
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';
const sort = url.searchParams.get('sort') || 'relevance';
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 12;
const offset = (page - 1) * limit;

// Obtener productos iniciales desde la API
let products: Product[] = [];
let total = 0;

try {
  const filters: Record<string, any> = {
    search: searchQuery,
    limit,
    offset
  };

  if (sort && sort !== 'relevance') filters.sort = sort;

  const result = await getProducts(filters);
  products = result.products;
  total = result.total;
} catch (error) {
  console.error('Error al buscar productos:', error);
  products = [];
  total = 0;
}

// Calcular paginación
const totalPages = Math.ceil(total / limit);

// Filtros disponibles
const priceRanges = [
  { label: 'Menos de 25€', minPrice: 0, maxPrice: 25 },
  { label: '25€ - 50€', minPrice: 25, maxPrice: 50 },
  { label: '50€ - 100€', minPrice: 50, maxPrice: 100 },
  { label: 'Más de 100€', minPrice: 100, maxPrice: 9999 }
];

// Categorías principales
const categoryList = [
  { value: 'deportes', label: 'Deportes' },
  { value: 'juguetes', label: 'Juguetes' },
  { value: 'hobbies', label: 'Hobbies' },
];

// Marcas - cargar desde la API (todas las marcas activas)
let brandList: { id: string; name: string; slug: string }[] = [];
try {
  brandList = await getBrands();
} catch (error) {
  console.error('Error al cargar marcas:', error);
  brandList = [];
}

// Colores disponibles
const colorList = ['Negro', 'Blanco', 'Azul', 'Rojo', 'Verde', 'Amarillo', 'Naranja', 'Rosa', 'Gris', 'Multicolor'];

const pageTitle = searchQuery
  ? `Resultados para "${searchQuery}"`
  : 'Búsqueda de Productos';
---

<Layout title={`${pageTitle} - Deportes y Juguetes Eva`} description="Encuentra los mejores productos de deportes, juguetes y hobbies">
  <Header />

  <main class="bg-background-light min-h-screen">
    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200">
      <div class="container mx-auto px-4 py-4">
        <nav class="flex items-center text-sm flex-wrap">
          <a href="/" class="text-gray-500 hover:text-secondary transition-colors">Inicio</a>
          <i class="material-icons text-gray-400 text-sm mx-2">chevron_right</i>
          <span class="text-secondary font-medium">Búsqueda</span>
        </nav>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <!-- Header de Búsqueda -->
      <div class="mb-8">
        <h1 class="text-4xl md:text-5xl font-display font-extrabold text-secondary mb-4">
          {pageTitle}
        </h1>
        {searchQuery && (
          <p class="text-gray-600 text-lg">
            Mostrando resultados para: <span class="font-bold text-secondary">"{searchQuery}"</span>
          </p>
        )}
      </div>

      <!-- Botón de filtros móvil -->
      <div class="lg:hidden mb-4">
        <button
          id="mobile-filters-btn"
          class="flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-4 py-3 text-secondary font-bold shadow-sm hover:shadow-md transition-shadow"
        >
          <i class="material-icons">filter_list</i>
          Filtros
          <span id="mobile-filter-count" class="hidden bg-accent text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">0</span>
        </button>
      </div>

      <!-- Overlay móvil -->
      <div id="mobile-filters-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

      <!-- Panel de filtros móvil (slide-in) -->
      <div id="mobile-filters-panel" class="fixed inset-y-0 left-0 w-80 max-w-[85vw] bg-white z-50 transform -translate-x-full transition-transform duration-300 lg:hidden overflow-y-auto">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
          <h2 class="font-display font-bold text-lg">Filtros</h2>
          <button id="close-mobile-filters" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div class="p-4" id="mobile-filters-content">
          <!-- Los filtros se clonan aquí via JS -->
        </div>
        <div class="p-4 border-t border-gray-200 sticky bottom-0 bg-white flex gap-3">
          <button id="mobile-clear-filters" class="flex-1 py-3 border border-gray-300 rounded-lg font-bold text-gray-600 hover:bg-gray-50 transition-colors">
            Limpiar
          </button>
          <button id="mobile-apply-filters" class="flex-1 py-3 bg-secondary text-primary rounded-lg font-bold hover:bg-black transition-colors">
            Ver resultados
          </button>
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar de Filtros (solo desktop) -->
        <aside class="hidden lg:block lg:w-64 flex-shrink-0">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-24" id="desktop-filters">
            <div class="flex items-center justify-between mb-6">
              <h2 class="font-display font-bold text-lg">Filtros</h2>
              <button id="clear-filters" class="text-sm text-red-500 hover:text-red-700 hover:underline font-medium">Limpiar</button>
            </div>

            <!-- Categoría -->
            <div class="border border-gray-200 rounded-lg overflow-hidden mb-3">
              <button class="filter-accordion-button w-full flex justify-between items-center p-3 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
                <span class="font-bold text-secondary text-sm">Categoría</span>
                <i class="material-icons filter-accordion-icon text-gray-500">expand_more</i>
              </button>
              <div class="filter-accordion-content">
                <div class="p-3 bg-white border-t border-gray-200 space-y-2">
                  {categoryList.map((cat) => (
                    <label class="flex items-center gap-2 cursor-pointer group">
                      <input
                        type="checkbox"
                        class="filter-checkbox w-4 h-4 rounded border-gray-300 text-secondary focus:ring-secondary"
                        data-filter="category"
                        data-value={cat.value}
                      />
                      <span class="text-sm text-gray-700 group-hover:text-secondary transition-colors">{cat.label}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>

            <!-- Precio -->
            <div class="border border-gray-200 rounded-lg overflow-hidden mb-3">
              <button class="filter-accordion-button w-full flex justify-between items-center p-3 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
                <span class="font-bold text-secondary text-sm">Precio</span>
                <i class="material-icons filter-accordion-icon text-gray-500">expand_more</i>
              </button>
              <div class="filter-accordion-content">
                <div class="p-3 bg-white border-t border-gray-200 space-y-2">
                  {priceRanges.map((range, index) => (
                    <label class="flex items-center gap-2 cursor-pointer group">
                      <input
                        type="checkbox"
                        class="filter-checkbox w-4 h-4 rounded border-gray-300 text-secondary focus:ring-secondary"
                        data-filter="price"
                        data-min={range.minPrice}
                        data-max={range.maxPrice}
                        data-index={index}
                      />
                      <span class="text-sm text-gray-700 group-hover:text-secondary transition-colors">{range.label}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>

            <!-- Marca -->
            {brandList.length > 0 && (
              <div class="border border-gray-200 rounded-lg overflow-hidden mb-3">
                <button class="filter-accordion-button w-full flex justify-between items-center p-3 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
                  <span class="font-bold text-secondary text-sm">Marca</span>
                  <i class="material-icons filter-accordion-icon text-gray-500">expand_more</i>
                </button>
                <div class="filter-accordion-content">
                  <div class="p-3 bg-white border-t border-gray-200 space-y-2 max-h-48 overflow-y-auto">
                    {brandList.map((brand) => (
                      <label class="flex items-center gap-2 cursor-pointer group">
                        <input
                          type="checkbox"
                          class="filter-checkbox w-4 h-4 rounded border-gray-300 text-secondary focus:ring-secondary"
                          data-filter="brand"
                          data-value={brand.slug}
                          data-label={brand.name}
                        />
                        <span class="text-sm text-gray-700 group-hover:text-secondary transition-colors">{brand.name}</span>
                      </label>
                    ))}
                  </div>
                </div>
              </div>
            )}

            <!-- Color -->
            <div class="border border-gray-200 rounded-lg overflow-hidden mb-3">
              <button class="filter-accordion-button w-full flex justify-between items-center p-3 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
                <span class="font-bold text-secondary text-sm">Color</span>
                <i class="material-icons filter-accordion-icon text-gray-500">expand_more</i>
              </button>
              <div class="filter-accordion-content">
                <div class="p-3 bg-white border-t border-gray-200 space-y-2 max-h-48 overflow-y-auto">
                  {colorList.map((colorName) => (
                    <label class="flex items-center gap-2 cursor-pointer group">
                      <input
                        type="checkbox"
                        class="filter-checkbox w-4 h-4 rounded border-gray-300 text-secondary focus:ring-secondary"
                        data-filter="color"
                        data-value={colorName}
                      />
                      <span class="text-sm text-gray-700 group-hover:text-secondary transition-colors">{colorName}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>

            <!-- Disponibilidad -->
            <div class="border border-gray-200 rounded-lg overflow-hidden mb-3">
              <button class="filter-accordion-button w-full flex justify-between items-center p-3 bg-gray-50 text-left focus:outline-none hover:bg-gray-100 transition-colors">
                <span class="font-bold text-secondary text-sm">Disponibilidad</span>
                <i class="material-icons filter-accordion-icon text-gray-500">expand_more</i>
              </button>
              <div class="filter-accordion-content">
                <div class="p-3 bg-white border-t border-gray-200">
                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      class="filter-checkbox w-4 h-4 rounded border-gray-300 text-secondary focus:ring-secondary"
                      data-filter="inStock"
                      data-value="true"
                    />
                    <span class="text-sm text-gray-700 group-hover:text-secondary transition-colors">En stock</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Filtros activos -->
            <div id="active-filters" class="hidden mt-6 pt-6 border-t border-gray-200">
              <p class="text-xs text-gray-500 mb-2">Filtros activos:</p>
              <div id="active-filters-tags" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </aside>

        <!-- Productos -->
        <div class="flex-1">
          <!-- Barra de ordenación -->
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <p class="text-gray-600" id="products-count">
              Mostrando <span class="font-bold text-secondary">{products.length}</span> de <span class="font-bold text-secondary">{total}</span> productos
            </p>

            <div class="flex items-center gap-4">
              <!-- Vista (Grid/List) -->
              <div class="flex items-center gap-2 bg-white rounded-lg border border-gray-200 p-1">
                <button class="p-2 bg-primary rounded text-secondary" aria-label="Vista de cuadrícula">
                  <i class="material-icons text-lg">grid_view</i>
                </button>
                <button class="p-2 text-gray-400 hover:text-secondary rounded" aria-label="Vista de lista">
                  <i class="material-icons text-lg">view_list</i>
                </button>
              </div>

              <!-- Ordenar -->
              <select
                id="sort-select"
                class="bg-white border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary"
              >
                <option value="relevance" selected={sort === 'relevance'}>Más relevantes</option>
                <option value="price_asc" selected={sort === 'price_asc'}>Precio: menor a mayor</option>
                <option value="price_desc" selected={sort === 'price_desc'}>Precio: mayor a menor</option>
                <option value="newest" selected={sort === 'newest'}>Novedades</option>
                <option value="bestseller" selected={sort === 'bestseller'}>Más vendidos</option>
              </select>
            </div>
          </div>

          <!-- Loading indicator -->
          <div id="loading-indicator" class="hidden flex justify-center items-center py-12">
            <div class="animate-spin w-10 h-10 border-4 border-primary border-t-transparent rounded-full"></div>
          </div>

          <!-- Grid de Productos -->
          <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {products.map((product) => (
              <div class="product-card-wrapper">
                <ProductCard product={product} />
              </div>
            ))}
          </div>

          <!-- Paginación -->
          <div id="pagination-container" class={totalPages > 1 ? 'mt-12 flex justify-center' : 'hidden'}>
            <nav class="flex items-center gap-2" id="pagination-nav">
              <!-- Se renderiza dinámicamente -->
            </nav>
          </div>

          <!-- Mensaje si no hay productos -->
          <div id="no-products" class={products.length === 0 ? 'text-center py-16' : 'hidden text-center py-16'}>
            <i class="material-icons text-6xl text-gray-300 mb-4">search_off</i>
            <h3 class="text-xl font-bold text-gray-600 mb-2">No se encontraron productos</h3>
            <p class="text-gray-500 mb-6">Prueba a cambiar los filtros o buscar algo diferente</p>
            <button id="clear-filters-empty" class="inline-block bg-primary text-secondary font-bold px-6 py-3 rounded-lg hover:bg-yellow-400 transition-colors">
              Limpiar filtros
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script define:vars={{ searchQuery, limit, priceRanges, products, total }}>
  window.searchQuery = searchQuery;
  window.limit = limit;
  window.priceRanges = priceRanges;
  window.initialProducts = products;
  window.initialTotal = total;
</script>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';

  interface FilterState {
    categories: string[];
    prices: { min: number; max: number }[];
    brands: string[];
    colors: string[];
    inStock: boolean;
    sort: string;
    page: number;
    viewMode: 'grid' | 'list';
  }

  const state: FilterState = {
    categories: [],
    prices: [],
    brands: [],
    colors: [],
    inStock: false,
    sort: 'relevance',
    page: 1,
    viewMode: 'grid'
  };

  let debounceTimer: ReturnType<typeof setTimeout>;
  let currentProducts: any[] = [];
  let currentTotal: number = 0;

  function debounce(fn: () => void, delay: number) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fn, delay);
  }

  // Re-renderizar productos sin hacer fetch (para cambio de vista)
  function rerenderCurrentProducts() {
    renderProducts(currentProducts, currentTotal);
  }

  async function fetchProducts() {
    const productsGrid = document.getElementById('products-grid');
    const noProducts = document.getElementById('no-products');

    // Solo una transición suave, sin spinner de carga
    if (productsGrid) productsGrid.style.opacity = '0.6';

    try {
      const params = new URLSearchParams();

      // Search query
      const searchQuery = (window as any).searchQuery;
      if (searchQuery) {
        params.set('search', searchQuery);
      }

      params.set('limit', String((window as any).limit));
      params.set('offset', String((state.page - 1) * (window as any).limit));

      // Categorías
      if (state.categories.length > 0) {
        // Si hay múltiples categorías, no enviamos filtro de categoría (busca en todas)
        // Si hay una sola, la enviamos
        if (state.categories.length === 1) {
          params.set('category', state.categories[0]);
        }
      }

      // Precio - combinar rangos seleccionados
      if (state.prices.length > 0) {
        const minPrice = Math.min(...state.prices.map(p => p.min));
        const maxPrice = Math.max(...state.prices.map(p => p.max));
        params.set('minPrice', String(minPrice));
        params.set('maxPrice', String(maxPrice));
      }

      // Marcas
      if (state.brands.length > 0) {
        params.set('brand', state.brands.join(','));
      }

      // Colores
      if (state.colors.length > 0) {
        params.set('color', state.colors.join(','));
      }

      // In Stock
      if (state.inStock) {
        params.set('inStock', 'true');
      }

      // Sort
      if (state.sort !== 'relevance') {
        params.set('sort', state.sort);
      }

      const response = await fetch(`${API_URL}/products?${params}`);
      const data = await response.json();

      renderProducts(data.products, data.total);
      renderPagination(data.total);
      updateActiveFilters();
    } catch (error) {
      console.error('Error fetching products:', error);
    } finally {
      if (productsGrid) productsGrid.style.opacity = '1';
    }
  }

  function renderProducts(products: any[], total: number) {
    // Guardar productos actuales para re-renderizar sin fetch
    currentProducts = products;
    currentTotal = total;

    const productsGrid = document.getElementById('products-grid');
    const noProducts = document.getElementById('no-products');
    const productsCount = document.getElementById('products-count');

    if (productsCount) {
      productsCount.innerHTML = `Mostrando <span class="font-bold text-secondary">${products.length}</span> de <span class="font-bold text-secondary">${total}</span> productos`;
    }

    if (products.length === 0) {
      if (productsGrid) productsGrid.classList.add('hidden');
      if (noProducts) noProducts.classList.remove('hidden');
      return;
    }

    if (productsGrid) productsGrid.classList.remove('hidden');
    if (noProducts) noProducts.classList.add('hidden');

    if (productsGrid) {
      productsGrid.innerHTML = products.map(product => {
        const image = product.thumbnailUrl || (product.images && product.images[0]) || '/placeholder.jpg';
        const price = typeof product.price === 'string' ? parseFloat(product.price) : product.price;
        const compareAtPrice = product.compareAtPrice ? (typeof product.compareAtPrice === 'string' ? parseFloat(product.compareAtPrice) : product.compareAtPrice) : null;
        const hasDiscount = compareAtPrice && compareAtPrice > price;
        const discountPercent = hasDiscount ? Math.round(((compareAtPrice! - price) / compareAtPrice!) * 100) : 0;

        // Vista lista - tarjeta horizontal compacta
        if (state.viewMode === 'list') {
          return `
            <div class="product-item">
              <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 group transition-all duration-300 hover:shadow-lg flex">
                <div class="relative w-32 h-32 sm:w-40 sm:h-40 flex-shrink-0 bg-gray-50 overflow-hidden">
                  <a href="/producto/${product.slug}">
                    <img
                      src="${image}"
                      alt="${product.name}"
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                      loading="lazy"
                    />
                  </a>
                  ${hasDiscount ? `
                    <span class="absolute top-2 left-2 bg-accent text-white text-xs font-bold px-1.5 py-0.5 rounded-full shadow-md">
                      -${discountPercent}%
                    </span>
                  ` : ''}
                </div>
                <div class="flex-1 p-4 flex flex-col justify-between">
                  <div>
                    ${product.category ? `<p class="text-xs text-gray-500 mb-1">${product.category.name}</p>` : ''}
                    <a href="/producto/${product.slug}">
                      <h3 class="font-bold text-secondary text-base mb-1 group-hover:text-gray-600 transition-colors line-clamp-1">
                        ${product.name}
                      </h3>
                    </a>
                    ${product.isNew ? `<span class="inline-block bg-secondary text-primary text-xs font-bold px-2 py-0.5 rounded-full">NUEVO</span>` : ''}
                  </div>
                  <div class="flex items-center justify-between gap-4 mt-2">
                    <div class="flex items-center gap-2">
                      <span class="text-xl font-bold text-secondary">${price.toFixed(2)}€</span>
                      ${hasDiscount ? `<span class="text-sm text-gray-400 line-through">${compareAtPrice!.toFixed(2)}€</span>` : ''}
                    </div>
                    <button
                      class="add-to-cart-btn bg-secondary text-primary hover:bg-black px-4 py-2 rounded-lg transition-all duration-200 text-sm font-bold flex items-center gap-2 shadow-md hover:shadow-lg"
                      data-product-id="${product.id}"
                      data-product-name="${product.name}"
                      data-product-slug="${product.slug}"
                      data-product-price="${price}"
                      data-product-image="${image}"
                    >
                      <i class="material-icons text-base">add_shopping_cart</i>
                      <span class="hidden sm:inline">Añadir</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        // Vista grid - tarjeta vertical
        return `
          <div class="product-item">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 group transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="relative aspect-square bg-gray-50 overflow-hidden">
                <a href="/producto/${product.slug}">
                  <img
                    src="${image}"
                    alt="${product.name}"
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    loading="lazy"
                  />
                </a>
                ${hasDiscount ? `
                  <span class="absolute top-3 left-3 bg-accent text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">
                    -${discountPercent}%
                  </span>
                ` : ''}
                ${product.isNew ? `
                  <span class="absolute top-3 right-3 bg-secondary text-primary text-xs font-bold px-2 py-1 rounded-full shadow-md">
                    NUEVO
                  </span>
                ` : ''}
              </div>
              <div class="p-4">
                ${product.category ? `<p class="text-xs text-gray-500 mb-1">${product.category.name}</p>` : ''}
                <a href="/producto/${product.slug}">
                  <h3 class="font-bold text-secondary text-sm mb-2 line-clamp-2 group-hover:text-gray-600 transition-colors">
                    ${product.name}
                  </h3>
                </a>
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-lg font-bold text-secondary">${price.toFixed(2)}€</span>
                  ${hasDiscount ? `<span class="text-sm text-gray-400 line-through">${compareAtPrice!.toFixed(2)}€</span>` : ''}
                </div>
                <button
                  class="add-to-cart-btn w-full bg-secondary text-primary hover:bg-black py-2 rounded-lg transition-all duration-200 text-sm font-bold flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                  data-product-id="${product.id}"
                  data-product-name="${product.name}"
                  data-product-slug="${product.slug}"
                  data-product-price="${price}"
                  data-product-image="${image}"
                >
                  <i class="material-icons text-base">add_shopping_cart</i>
                  Añadir
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Re-attach cart event listeners
      attachCartListeners();
    }
  }

  function attachCartListeners() {
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const productId = target.dataset.productId;
        const productName = target.dataset.productName;
        const productSlug = target.dataset.productSlug;
        const productPrice = parseFloat(target.dataset.productPrice || '0');
        const productImage = target.dataset.productImage;

        // Import and use cart functions
        import('@/lib/cart').then(({ addToCart }) => {
          addToCart({
            productId: productId!,
            productName: productName!,
            productSlug: productSlug!,
            productImage: productImage!,
            unitPrice: productPrice,
            quantity: 1
          });
        });

        import('@/lib/toast').then(({ toastSuccess }) => {
          toastSuccess('Producto añadido al carrito');
        });
      });
    });
  }

  function renderPagination(total: number) {
    const paginationContainer = document.getElementById('pagination-container');
    const paginationNav = document.getElementById('pagination-nav');
    const totalPages = Math.ceil(total / (window as any).limit);

    if (totalPages <= 1) {
      if (paginationContainer) paginationContainer.classList.add('hidden');
      return;
    }

    if (paginationContainer) paginationContainer.classList.remove('hidden');

    if (paginationNav) {
      let html = '';

      // Previous button
      if (state.page > 1) {
        html += `<button class="pagination-btn px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-secondary hover:text-primary hover:border-secondary transition-colors" data-page="${state.page - 1}"><i class="material-icons text-sm">chevron_left</i></button>`;
      } else {
        html += `<span class="px-4 py-2 border border-gray-200 rounded-lg text-gray-400 cursor-not-allowed"><i class="material-icons text-sm">chevron_left</i></span>`;
      }

      // Page numbers
      for (let i = 1; i <= Math.min(5, totalPages); i++) {
        if (i === state.page) {
          html += `<span class="px-4 py-2 rounded-lg font-bold bg-primary text-secondary">${i}</span>`;
        } else {
          html += `<button class="pagination-btn px-4 py-2 rounded-lg font-bold border border-gray-200 text-gray-700 hover:bg-secondary hover:text-primary hover:border-secondary transition-colors" data-page="${i}">${i}</button>`;
        }
      }

      // Next button
      if (state.page < totalPages) {
        html += `<button class="pagination-btn px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-secondary hover:text-primary hover:border-secondary transition-colors" data-page="${state.page + 1}"><i class="material-icons text-sm">chevron_right</i></button>`;
      } else {
        html += `<span class="px-4 py-2 border border-gray-200 rounded-lg text-gray-400 cursor-not-allowed"><i class="material-icons text-sm">chevron_right</i></span>`;
      }

      paginationNav.innerHTML = html;

      // Attach pagination listeners
      document.querySelectorAll('.pagination-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          state.page = parseInt(target.dataset.page || '1');
          fetchProducts();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }
  }

  function updateActiveFilters() {
    const activeFiltersContainer = document.getElementById('active-filters');
    const activeFiltersTags = document.getElementById('active-filters-tags');

    const hasFilters = state.categories.length > 0 || state.prices.length > 0 || state.brands.length > 0 ||
                       state.colors.length > 0 || state.inStock;

    if (!hasFilters) {
      if (activeFiltersContainer) activeFiltersContainer.classList.add('hidden');
      return;
    }

    if (activeFiltersContainer) activeFiltersContainer.classList.remove('hidden');

    if (activeFiltersTags) {
      let html = '';

      // Category tags
      const categoryLabels: Record<string, string> = { deportes: 'Deportes', juguetes: 'Juguetes', hobbies: 'Hobbies' };
      state.categories.forEach(cat => {
        html += `<button class="remove-filter inline-flex items-center gap-1 bg-primary/20 text-secondary text-xs px-2 py-1 rounded hover:bg-primary/30 transition-colors" data-filter="category" data-value="${cat}">
          ${categoryLabels[cat] || cat}
          <i class="material-icons text-xs">close</i>
        </button>`;
      });

      // Price tags
      state.prices.forEach((price, index) => {
        const range = (window as any).priceRanges.find((r: any) => r.minPrice === price.min && r.maxPrice === price.max);
        if (range) {
          html += `<button class="remove-filter inline-flex items-center gap-1 bg-primary/20 text-secondary text-xs px-2 py-1 rounded hover:bg-primary/30 transition-colors" data-filter="price" data-index="${index}">
            ${range.label}
            <i class="material-icons text-xs">close</i>
          </button>`;
        }
      });

      // Brand tags
      state.brands.forEach(brandSlug => {
        // Buscar el label de la marca por su slug
        const brandCheckbox = document.querySelector(`[data-filter="brand"][data-value="${brandSlug}"]`) as HTMLInputElement;
        const brandLabel = brandCheckbox?.dataset.label || brandSlug;
        html += `<button class="remove-filter inline-flex items-center gap-1 bg-primary/20 text-secondary text-xs px-2 py-1 rounded hover:bg-primary/30 transition-colors" data-filter="brand" data-value="${brandSlug}">
          ${brandLabel}
          <i class="material-icons text-xs">close</i>
        </button>`;
      });

      // Color tags
      state.colors.forEach(color => {
        html += `<button class="remove-filter inline-flex items-center gap-1 bg-primary/20 text-secondary text-xs px-2 py-1 rounded hover:bg-primary/30 transition-colors" data-filter="color" data-value="${color}">
          ${color}
          <i class="material-icons text-xs">close</i>
        </button>`;
      });

      // In stock tag
      if (state.inStock) {
        html += `<button class="remove-filter inline-flex items-center gap-1 bg-primary/20 text-secondary text-xs px-2 py-1 rounded hover:bg-primary/30 transition-colors" data-filter="inStock">
          En stock
          <i class="material-icons text-xs">close</i>
        </button>`;
      }

      activeFiltersTags.innerHTML = html;

      // Attach remove filter listeners
      document.querySelectorAll('.remove-filter').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const filter = target.dataset.filter;
          const value = target.dataset.value;
          const index = target.dataset.index;

          if (filter === 'category' && value) {
            state.categories = state.categories.filter(c => c !== value);
            const checkbox = document.querySelector(`[data-filter="category"][data-value="${value}"]`) as HTMLInputElement;
            if (checkbox) checkbox.checked = false;
          } else if (filter === 'price' && index !== undefined) {
            state.prices.splice(parseInt(index), 1);
            // Uncheck corresponding checkbox
            const checkbox = document.querySelector(`[data-filter="price"][data-index="${index}"]`) as HTMLInputElement;
            if (checkbox) checkbox.checked = false;
          } else if (filter === 'brand' && value) {
            state.brands = state.brands.filter(b => b !== value);
            const checkbox = document.querySelector(`[data-filter="brand"][data-value="${value}"]`) as HTMLInputElement;
            if (checkbox) checkbox.checked = false;
          } else if (filter === 'color' && value) {
            state.colors = state.colors.filter(c => c !== value);
            const checkbox = document.querySelector(`[data-filter="color"][data-value="${value}"]`) as HTMLInputElement;
            if (checkbox) checkbox.checked = false;
          } else if (filter === 'inStock') {
            state.inStock = false;
            const checkbox = document.querySelector(`[data-filter="inStock"]`) as HTMLInputElement;
            if (checkbox) checkbox.checked = false;
          }

          state.page = 1;
          fetchProducts();
        });
      });
    }
  }

  function clearAllFilters() {
    state.categories = [];
    state.prices = [];
    state.brands = [];
    state.colors = [];
    state.inStock = false;
    state.page = 1;

    // Uncheck all checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
      (checkbox as HTMLInputElement).checked = false;
    });

    fetchProducts();
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // Filter checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const filter = target.dataset.filter;
        const value = target.dataset.value;
        const min = target.dataset.min;
        const max = target.dataset.max;

        if (filter === 'category' && value) {
          if (target.checked) {
            state.categories.push(value);
          } else {
            state.categories = state.categories.filter(c => c !== value);
          }
        } else if (filter === 'price' && min !== undefined && max !== undefined) {
          if (target.checked) {
            state.prices.push({ min: parseFloat(min), max: parseFloat(max) });
          } else {
            state.prices = state.prices.filter(p => !(p.min === parseFloat(min) && p.max === parseFloat(max)));
          }
        } else if (filter === 'brand' && value) {
          if (target.checked) {
            state.brands.push(value);
          } else {
            state.brands = state.brands.filter(b => b !== value);
          }
        } else if (filter === 'color' && value) {
          if (target.checked) {
            state.colors.push(value);
          } else {
            state.colors = state.colors.filter(c => c !== value);
          }
        } else if (filter === 'inStock') {
          state.inStock = target.checked;
        }

        state.page = 1;
        debounce(fetchProducts, 300);
      });
    });

    // Sort select
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    sortSelect?.addEventListener('change', () => {
      state.sort = sortSelect.value;
      state.page = 1;
      fetchProducts();
    });

    // Clear filters buttons
    document.getElementById('clear-filters')?.addEventListener('click', clearAllFilters);
    document.getElementById('clear-filters-empty')?.addEventListener('click', clearAllFilters);

    // Filter accordions
    document.querySelectorAll('.filter-accordion-button').forEach(button => {
      button.addEventListener('click', () => {
        button.classList.toggle('collapsed');
      });
    });

    // Vista grid/list toggle
    const gridBtn = document.querySelector('[aria-label="Vista de cuadrícula"]') as HTMLButtonElement;
    const listBtn = document.querySelector('[aria-label="Vista de lista"]') as HTMLButtonElement;
    const productsGrid = document.getElementById('products-grid');

    gridBtn?.addEventListener('click', () => {
      if (state.viewMode === 'grid') return;
      state.viewMode = 'grid';
      gridBtn.classList.add('bg-primary', 'text-secondary');
      gridBtn.classList.remove('text-gray-400');
      listBtn?.classList.remove('bg-primary', 'text-secondary');
      listBtn?.classList.add('text-gray-400');
      productsGrid?.classList.remove('grid-cols-1', 'lg:grid-cols-2');
      productsGrid?.classList.add('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-3', 'xl:grid-cols-4');
      // Re-renderizar sin fetch, solo cambia el template
      if (currentProducts.length > 0) {
        rerenderCurrentProducts();
      }
    });

    listBtn?.addEventListener('click', () => {
      if (state.viewMode === 'list') return;
      state.viewMode = 'list';
      listBtn.classList.add('bg-primary', 'text-secondary');
      listBtn.classList.remove('text-gray-400');
      gridBtn?.classList.remove('bg-primary', 'text-secondary');
      gridBtn?.classList.add('text-gray-400');
      productsGrid?.classList.remove('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-3', 'xl:grid-cols-4');
      productsGrid?.classList.add('grid-cols-1', 'lg:grid-cols-2');
      // Re-renderizar sin fetch, solo cambia el template
      if (currentProducts.length > 0) {
        rerenderCurrentProducts();
      }
    });

    // Inicializar productos actuales con los datos SSR (para cambio de vista sin fetch)
    const initialProducts = (window as any).initialProducts || [];
    const initialTotal = (window as any).initialTotal || 0;
    currentProducts = initialProducts;
    currentTotal = initialTotal;

    // Solo renderizar paginación inicial (productos ya vienen renderizados por Astro SSR)
    renderPagination(initialTotal);

    // Attach cart listeners a los productos ya renderizados por SSR
    attachCartListeners();

    // Mobile filters panel
    const mobileFiltersBtn = document.getElementById('mobile-filters-btn');
    const mobileFiltersPanel = document.getElementById('mobile-filters-panel');
    const mobileFiltersOverlay = document.getElementById('mobile-filters-overlay');
    const closeMobileFilters = document.getElementById('close-mobile-filters');
    const mobileApplyFilters = document.getElementById('mobile-apply-filters');
    const mobileClearFilters = document.getElementById('mobile-clear-filters');
    const mobileFiltersContent = document.getElementById('mobile-filters-content');
    const mobileFilterCount = document.getElementById('mobile-filter-count');
    const desktopFilters = document.getElementById('desktop-filters');

    function openMobileFilters() {
      mobileFiltersPanel?.classList.remove('-translate-x-full');
      mobileFiltersOverlay?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeMobileFiltersPanel() {
      mobileFiltersPanel?.classList.add('-translate-x-full');
      mobileFiltersOverlay?.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateMobileFilterCount() {
      const count = state.categories.length + state.prices.length + state.brands.length +
                    state.colors.length + (state.inStock ? 1 : 0);
      if (mobileFilterCount) {
        if (count > 0) {
          mobileFilterCount.textContent = String(count);
          mobileFilterCount.classList.remove('hidden');
        } else {
          mobileFilterCount.classList.add('hidden');
        }
      }
    }

    // Clone desktop filters to mobile panel
    if (desktopFilters && mobileFiltersContent) {
      // Clone all filter accordions
      const filterAccordions = desktopFilters.querySelectorAll('.border.border-gray-200.rounded-lg');
      filterAccordions.forEach(accordion => {
        const clone = accordion.cloneNode(true) as HTMLElement;
        // Update IDs to avoid conflicts
        clone.querySelectorAll('[id]').forEach(el => {
          el.id = 'mobile-' + el.id;
        });
        // Re-add accordion functionality
        const btn = clone.querySelector('.filter-accordion-button');
        btn?.addEventListener('click', () => {
          btn.classList.toggle('collapsed');
        });
        // Sync checkboxes with desktop
        clone.querySelectorAll('.filter-checkbox').forEach(checkbox => {
          const cb = checkbox as HTMLInputElement;
          const filter = cb.dataset.filter;
          const value = cb.dataset.value;
          const min = cb.dataset.min;
          const max = cb.dataset.max;

          // Sync initial state
          const desktopCb = desktopFilters.querySelector(
            filter === 'price'
              ? `[data-filter="price"][data-min="${min}"][data-max="${max}"]`
              : `[data-filter="${filter}"][data-value="${value}"]`
          ) as HTMLInputElement;
          if (desktopCb) {
            cb.checked = desktopCb.checked;
          }

          // Sync on change
          cb.addEventListener('change', () => {
            if (desktopCb) {
              desktopCb.checked = cb.checked;
              desktopCb.dispatchEvent(new Event('change'));
            }
            updateMobileFilterCount();
          });
        });
        mobileFiltersContent.appendChild(clone);
      });
    }

    mobileFiltersBtn?.addEventListener('click', openMobileFilters);
    closeMobileFilters?.addEventListener('click', closeMobileFiltersPanel);
    mobileFiltersOverlay?.addEventListener('click', closeMobileFiltersPanel);
    mobileApplyFilters?.addEventListener('click', () => {
      closeMobileFiltersPanel();
      fetchProducts();
      updateMobileFilterCount();
    });
    mobileClearFilters?.addEventListener('click', () => {
      clearAllFilters();
      // Also clear mobile checkboxes
      mobileFiltersContent?.querySelectorAll('.filter-checkbox').forEach(cb => {
        (cb as HTMLInputElement).checked = false;
      });
      updateMobileFilterCount();
    });
  });
</script>

<style>
  /* Transición suave para el grid de productos */
  #products-grid {
    transition: opacity 0.15s ease;
  }

  /* Filter accordion styles */
  .filter-accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .filter-accordion-button:not(.collapsed) + .filter-accordion-content {
    max-height: 500px;
  }

  .filter-accordion-icon {
    transition: transform 0.3s ease;
  }

  .filter-accordion-button:not(.collapsed) .filter-accordion-icon {
    transform: rotate(180deg);
  }
</style>
