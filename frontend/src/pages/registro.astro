---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
---

<Layout title="Crear Cuenta - Deportes y Juguetes Eva" description="Crea tu cuenta">
  <Header />

  <main class="bg-background-light min-h-screen py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
        <!-- Logo/Título -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-display font-extrabold uppercase italic text-secondary mb-2">
            Crear Cuenta
          </h1>
          <p class="text-gray-600">Únete a Deportes y Juguetes Eva</p>
        </div>

        <!-- Formulario -->
        <form id="register-form" class="space-y-6">
          <!-- Nombre -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">
                Nombre <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="firstName"
                name="firstName"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="Juan"
              />
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">
                Apellido <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="lastName"
                name="lastName"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="Pérez"
              />
            </div>
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="tu@email.com"
            />
          </div>

          <!-- Teléfono -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
              Teléfono (opcional)
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="+34 600 000 000"
            />
          </div>

          <!-- Contraseña -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Contraseña <span class="text-red-500">*</span>
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="8"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="Mínimo 8 caracteres"
            />
            <p class="mt-1.5 text-xs text-gray-500">
              Debe incluir: mayúscula, minúscula y número
            </p>
          </div>

          <!-- Confirmar Contraseña -->
          <div>
            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
              Confirmar Contraseña <span class="text-red-500">*</span>
            </label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required
              minlength="8"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="••••••••"
            />
          </div>

          <!-- Acepta Marketing -->
          <div class="flex items-start">
            <input
              type="checkbox"
              id="acceptsMarketing"
              name="acceptsMarketing"
              class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
            />
            <label for="acceptsMarketing" class="ml-3 text-sm text-gray-600">
              Quiero recibir ofertas y novedades por email
            </label>
          </div>

          <!-- Error message -->
          <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
          </div>

          <!-- Botón -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-primary hover:bg-yellow-400 text-black font-bold py-3 px-8 rounded-lg uppercase tracking-wider transition-all transform hover:-translate-y-1 shadow-lg"
          >
            Crear Cuenta
          </button>
        </form>

        <!-- Login -->
        <div class="mt-6 text-center">
          <p class="text-gray-600">
            ¿Ya tienes cuenta?
            <a href="/login" class="text-primary font-bold hover:underline">
              Inicia sesión aquí
            </a>
          </p>
        </div>

        <!-- Continuar sin cuenta -->
        <div class="mt-4 text-center">
          <a href="/" class="text-gray-500 text-sm hover:underline">
            Continuar sin crear cuenta
          </a>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  import { register } from '@/lib/auth';
  import { toastSuccess, toastError } from '@/lib/toast';

  const form = document.getElementById('register-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const password = formData.get('password') as string;
    const confirmPassword = formData.get('confirmPassword') as string;

    // Ocultar error previo
    errorMessage.classList.add('hidden');

    // Validar contraseñas
    if (password !== confirmPassword) {
      errorMessage.textContent = 'Las contraseñas no coinciden';
      errorMessage.classList.remove('hidden');
      toastError('Las contraseñas no coinciden');
      return;
    }

    // Deshabilitar botón
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creando cuenta...';

    try {
      const result = await register({
        email: formData.get('email') as string,
        password,
        firstName: formData.get('firstName') as string,
        lastName: formData.get('lastName') as string,
        phone: formData.get('phone') as string || undefined,
        acceptsMarketing: formData.get('acceptsMarketing') === 'on',
      });

      if (result.success) {
        toastSuccess('¡Cuenta creada exitosamente!');

        // Redirigir a cuenta después de un breve delay
        setTimeout(() => {
          window.location.href = '/cuenta';
        }, 500);
      } else {
        errorMessage.textContent = result.message || 'Error al crear la cuenta';
        errorMessage.classList.remove('hidden');
        toastError(result.message || 'Error al crear la cuenta');
      }
    } catch (error) {
      console.error('Register error:', error);
      errorMessage.textContent = 'Error de conexión. Por favor intenta de nuevo.';
      errorMessage.classList.remove('hidden');
      toastError('Error de conexión');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Crear Cuenta';
    }
  });
</script>
