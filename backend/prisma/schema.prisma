// Schema Prisma - Deportes y Juguetes Eva
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ MARCAS ============
model Brand {
  id           String  @id @default(cuid())
  name         String  @unique
  slug         String  @unique
  logoUrl      String?
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

// ============ PRODUCTOS Y CATEGORÍAS ============
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  imageUrl    String?

  // Jerarquía: Deportes > Running, Juguetes > Infantiles, etc.
  parentId String?
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children Category[] @relation("CategoryToCategory")

  products Product[]

  // Para megamenu: 'deportes', 'juguetes', 'hobbies'
  menuSection String?

  // Destacada en home
  isFeatured Boolean @default(false)

  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([slug])
  @@index([menuSection])
}

enum SportType {
  RUNNING
  TRAIL_RUNNING
  FITNESS
  NATACION
  OUTDOOR
  CASUAL
}

enum CollectionType {
  SCALEXTRIC
  TRENES_ELECTRICOS
  MAQUETAS
  OTROS
}

enum ProductType {
  // Deportes
  ZAPATILLAS
  CAMISETAS
  PANTALONES
  CHAQUETAS
  GORRAS
  CALCETINES
  ACCESORIOS
  EQUIPAMIENTO
  // Juguetes
  MUNECAS
  VEHICULOS
  CONSTRUCCION
  JUEGOS_MESA
  PELUCHES
  FIGURAS
  // Hobbies
  CIRCUITOS
  TRENES
  MAQUETAS_AVIONES
  MAQUETAS_COCHES
  MAQUETAS_BARCOS
}

// ============ ETIQUETAS DE PRODUCTO ============
// Para estados/promociones: Rebajas, Navidad, Black Friday, Nuevo, etc.
model ProductTag {
  id          String   @id @default(cuid())
  name        String   @unique // "Rebajas", "Navidad", "Black Friday"
  slug        String   @unique
  description String?
  color       String?  // Color para mostrar en badges (hex)
  icon        String?  // Icono Material Icons
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  // Fechas opcionales para promociones temporales
  startDate   DateTime?
  endDate     DateTime?

  products    ProductsOnTags[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([slug])
}

// Tabla intermedia para relación muchos a muchos
model ProductsOnTags {
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   String
  tag         ProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId       String
  assignedAt  DateTime   @default(now())

  @@id([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

model Product {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String   @db.Text
  shortDescription String? // Para cards de producto
  price            Decimal  @db.Decimal(10, 2)
  compareAtPrice   Decimal? @db.Decimal(10, 2) // Precio antes de descuento
  stock            Int      @default(0)
  sku              String?  @unique
  barcode          String?  @unique // Código de barras EAN-13 del fabricante

  // Imágenes (URLs de Supabase Storage)
  images       String[]
  thumbnailUrl String?

  // Categorización
  categoryId     String
  category       Category        @relation(fields: [categoryId], references: [id])
  sportType      SportType?
  productType    ProductType?
  isCollectible  Boolean         @default(false)
  collectionType CollectionType?

  // Características adicionales
  brandId        String?
  brand          Brand?  @relation(fields: [brandId], references: [id])
  color          String?
  size           String?
  weight         String?
  specifications Json? // Objeto flexible para specs técnicas

  // Variantes (si el producto tiene variantes)
  hasVariants Boolean          @default(false)
  variants    ProductVariant[]

  // SEO
  metaTitle       String?
  metaDescription String?

  // Destacados
  isFeatured   Boolean @default(false)
  isNew        Boolean @default(false)
  isBestSeller Boolean @default(false)

  // Relaciones
  orderItems OrderItem[]
  reviews    Review[]
  tags       ProductsOnTags[]

  isActive    Boolean   @default(true)
  deletedAt   DateTime? // Papelera de reciclaje - si tiene valor, está en la papelera
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([categoryId])
  @@index([deletedAt])
  @@index([brandId])
  @@index([slug])
  @@index([barcode])
  @@index([isActive])
  @@index([isFeatured])
  @@index([sportType])
  @@index([productType])
  @@index([collectionType])
}

// Variantes de producto (talla, color, etc.)
model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Atributos de la variante
  size     String? // Talla: XS, S, M, L, XL, 38, 39, 40, etc.
  color    String? // Color: Rojo, Azul, Negro, etc.
  colorHex String? // Código hex del color para mostrar en UI
  material String? // Material: Algodón, Poliéster, etc.

  // Precio y stock de la variante
  price   Decimal? @db.Decimal(10, 2) // Si null, usa el precio del producto
  stock   Int      @default(0)
  sku     String?  @unique
  barcode String?  @unique // Código de barras EAN-13 (cada variante puede tener el suyo)

  // Imagen específica de esta variante
  imageUrl String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([size])
  @@index([color])
  @@index([barcode])
}

// ============ PEDIDOS ============
enum OrderStatus {
  PENDING // Creado, esperando pago
  PAID // Pagado
  PROCESSING // En preparación
  SHIPPED // Enviado
  DELIVERED // Entregado
  CANCELLED // Cancelado
}

enum PaymentMethod {
  STRIPE
  TRANSFER
  CASH
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique // EVA-20260109-0001

  // Cliente
  userEmail String
  userName  String
  userPhone String

  // Dirección de envío
  shippingAddress    String
  shippingCity       String
  shippingPostalCode String
  shippingProvince   String?
  shippingCountry    String  @default("España")

  // Dirección de facturación (opcional, si diferente)
  billingAddress    String?
  billingCity       String?
  billingPostalCode String?
  billingProvince   String?
  billingCountry    String?

  // DNI/NIE (para factura)
  taxId String?

  // Pedido
  items        OrderItem[]
  subtotal     Decimal     @db.Decimal(10, 2)
  shippingCost Decimal     @default(0) @db.Decimal(10, 2)
  discount     Decimal     @default(0) @db.Decimal(10, 2)
  total        Decimal     @db.Decimal(10, 2)
  status       OrderStatus @default(PENDING)

  // Método de pago
  paymentMethod PaymentMethod
  paymentStatus String        @default("pending")

  // Control de emails enviados
  emailSentConfirmed Boolean @default(false)
  emailSentPaid      Boolean @default(false)
  emailSentShipped   Boolean @default(false)
  emailSentDelivered Boolean @default(false)
  emailSentCancelled Boolean @default(false)

  // Pago Stripe
  stripePaymentIntentId String?   @unique
  stripeSessionId       String?   @unique
  paidAt                DateTime?

  // Envío
  trackingNumber  String?
  shippingCarrier String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Cancelación
  cancellationReason String?   @db.Text
  cancelledAt        DateTime?
  refundedAt         DateTime?

  // Notas
  customerNotes String? @db.Text
  adminNotes    String? @db.Text

  // Cupón aplicado
  couponId   String?
  coupon     Coupon? @relation("OrderCoupon", fields: [couponId], references: [id])
  couponCode String? // Snapshot del código usado

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userEmail])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([paymentMethod])
  @@index([couponId])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  // Snapshot de datos (por si el producto cambia/se elimina)
  productName  String
  productImage String?
  productSku   String?

  // Variante seleccionada (opcional)
  variantId    String?
  variantSize  String?
  variantColor String?

  @@index([orderId])
  @@index([productId])
}

// ============ SISTEMA DE EMAILS ============
enum EmailType {
  CONFIRMATION // Cliente: Pedido creado
  PAID // Cliente: Pedido pagado
  PROCESSING // Cliente: Pedido en preparación
  SHIPPED // Cliente: Pedido enviado
  DELIVERED // Cliente: Pedido entregado
  CANCELLED // Cliente: Pedido cancelado
  WELCOME // Cliente: Cuenta creada (futuro)
  ADMIN_NEW_ORDER // Admin: Nuevo pedido
  ADMIN_PAID // Admin: Pedido pagado
  ADMIN_CANCELLED // Admin: Pedido cancelado
}

model EmailTemplate {
  id        String    @id @default(cuid())
  type      EmailType @unique
  subject   String
  body      String    @db.Text
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([type])
}

model EmailLog {
  id           String    @id @default(cuid())
  type         EmailType
  recipient    String
  subject      String
  orderId      String?
  status       String // 'sent', 'failed', 'pending'
  errorMessage String?   @db.Text
  sentAt       DateTime?
  createdAt    DateTime  @default(now())

  @@index([orderId])
  @@index([recipient])
  @@index([status])
}

// ============ USUARIOS ADMIN ============
model AdminUser {
  id          String    @id @default(cuid())
  email       String    @unique
  supabaseId  String    @unique
  name        String?
  role        String    @default("admin") // 'admin', 'super_admin'
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([supabaseId])
  @@index([email])
}

// ============ CLIENTES ============
model Customer {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String? // Hash bcrypt de la contraseña
  supabaseId   String? @unique // Si se registra con Supabase Auth

  // Datos personales
  firstName String
  lastName  String
  phone     String?
  gender    String? // 'male', 'female', 'other', 'prefer_not_to_say'

  // DNI/NIE para facturas
  taxId String?

  // Fechas
  birthDate DateTime?

  // Estado
  isActive Boolean   @default(true)
  isVip    Boolean   @default(false)
  vipSince DateTime?

  // Puntos de fidelidad
  loyaltyPoints Int @default(0)

  // Marketing
  acceptsMarketing Boolean @default(false)

  // Notas internas
  notes String? @db.Text

  // Relaciones
  addresses CustomerAddress[]
  wishlist  WishlistItem[]

  // Estadísticas (desnormalizadas para consultas rápidas)
  totalOrders Int       @default(0)
  totalSpent  Decimal   @default(0) @db.Decimal(10, 2)
  lastOrderAt DateTime?
  lastLoginAt DateTime? // Último inicio de sesión

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([supabaseId])
  @@index([isActive])
  @@index([isVip])
}

model CustomerAddress {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Tipo de dirección
  type      String  @default("shipping") // 'shipping', 'billing'
  label     String? // "Casa", "Trabajo", etc.
  isDefault Boolean @default(false)

  // Datos de la dirección
  firstName    String
  lastName     String
  company      String?
  address      String
  addressLine2 String? // Piso, puerta, etc.
  city         String
  province     String?
  postalCode   String
  country      String  @default("España")
  phone        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([type])
  @@index([isDefault])
}

model WishlistItem {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId  String

  // Snapshot del producto
  productName  String
  productSlug  String
  productImage String?
  productPrice Decimal @db.Decimal(10, 2)

  addedAt DateTime @default(now())

  @@unique([customerId, productId])
  @@index([customerId])
  @@index([productId])
}

// ============ CONFIGURACIÓN ============
model SiteConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  group       String? // 'general', 'payment', 'shipping', 'email'
  type        String   @default("text") // 'text', 'number', 'boolean', 'json'
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([group])
}

// Configuración específica para métodos de pago
model PaymentMethodConfig {
  id           String        @id @default(cuid())
  method       PaymentMethod @unique
  isEnabled    Boolean       @default(false)
  displayName  String
  description  String?       @db.Text
  instructions String?       @db.Text // Instrucciones para el cliente
  displayOrder Int           @default(0)

  // Configuración específica por método
  config Json? // Ej: {accountNumber, bankName} para transfer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([method])
  @@index([isEnabled])
}

// ============ FEATURE FLAGS ============
model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  isEnabled   Boolean  @default(false)
  group       String? // 'marketing', 'notifications', 'checkout', etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([group])
  @@index([isEnabled])
}

// ============ CAMPAÑAS DE EMAIL MARKETING ============
enum CampaignStatus {
  DRAFT // Borrador
  SCHEDULED // Programada
  SENDING // Enviando
  SENT // Enviada
  CANCELLED // Cancelada
}

model EmailCampaign {
  id          String  @id @default(cuid())
  name        String
  subject     String
  previewText String? // Texto de vista previa
  body        String  @db.Text

  // Segmentación
  targetAudience String @default("all") // 'all', 'customers', 'subscribers'
  targetFilters  Json? // Filtros adicionales: {minOrders: 1, lastPurchaseDays: 30}

  // Estado y programación
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?
  sentAt      DateTime?

  // Estadísticas
  totalRecipients   Int @default(0)
  totalSent         Int @default(0)
  totalOpened       Int @default(0)
  totalClicked      Int @default(0)
  totalBounced      Int @default(0)
  totalUnsubscribed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con logs
  logs CampaignEmailLog[]

  @@index([status])
  @@index([scheduledAt])
}

model CampaignEmailLog {
  id         String        @id @default(cuid())
  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  recipient    String
  status       String // 'sent', 'opened', 'clicked', 'bounced', 'unsubscribed'
  openedAt     DateTime?
  clickedAt    DateTime?
  sentAt       DateTime?
  errorMessage String?   @db.Text

  createdAt DateTime @default(now())

  @@index([campaignId])
  @@index([recipient])
  @@index([status])
}

// Lista de suscriptores para email marketing
model EmailSubscriber {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?

  // Origen de la suscripción
  source String @default("website") // 'website', 'checkout', 'import'

  // Estado
  isActive       Boolean   @default(true)
  unsubscribedAt DateTime?

  // Datos adicionales
  metadata Json? // {ordersCount, lastOrderAt, etc.}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
  @@index([source])
}

// ============ CUPONES Y DESCUENTOS ============
enum CouponType {
  PERCENTAGE // Descuento porcentual
  FIXED_AMOUNT // Cantidad fija
  FREE_SHIPPING // Envío gratis
}

model Coupon {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  // Tipo y valor del descuento
  type  CouponType
  value Decimal    @db.Decimal(10, 2) // Porcentaje o cantidad fija

  // Restricciones
  minOrderAmount    Decimal? @db.Decimal(10, 2) // Mínimo de compra
  maxDiscount       Decimal? @db.Decimal(10, 2) // Descuento máximo (para porcentajes)
  usageLimit        Int? // Límite total de usos
  usageLimitPerUser Int? // Límite por usuario
  usageCount        Int      @default(0)

  // Validez
  startsAt  DateTime  @default(now())
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  // Restricciones de productos/categorías (JSON arrays de IDs)
  applicableProducts   String[] // IDs de productos aplicables (vacío = todos)
  applicableCategories String[] // IDs de categorías aplicables (vacío = todas)
  excludedProducts     String[] // IDs de productos excluidos

  // Seguimiento
  orders Order[] @relation("OrderCoupon")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

// ============ RESEÑAS Y VALORACIONES ============
model Review {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Autor (puede ser cliente registrado o anónimo)
  customerId  String?
  authorName  String
  authorEmail String

  // Contenido
  rating  Int // 1-5 estrellas
  title   String?
  comment String  @db.Text
  pros    String? @db.Text
  cons    String? @db.Text

  // Verificación
  isVerified Boolean @default(false) // Compra verificada
  orderId    String? // Pedido asociado

  // Moderación
  status     String  @default("pending") // pending, approved, rejected
  adminNotes String? @db.Text

  // Utilidad
  helpfulCount    Int @default(0)
  notHelpfulCount Int @default(0)

  // Imágenes del review
  images String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([customerId])
  @@index([status])
  @@index([rating])
}

// ============ NOTIFICACIONES DE STOCK ============
model StockNotification {
  id         String    @id @default(cuid())
  productId  String
  variantId  String? // Si es para una variante específica
  email      String
  notified   Boolean   @default(false)
  notifiedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([productId, variantId, email])
  @@index([productId])
  @@index([notified])
}

// ============ FAQ ============
model FaqCategory {
  id           String  @id @default(cuid())
  name         String
  slug         String  @unique
  description  String?
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  questions FaqQuestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

model FaqQuestion {
  id         String      @id @default(cuid())
  categoryId String
  category   FaqCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  question     String
  answer       String  @db.Text
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Para analytics
  viewCount    Int @default(0)
  helpfulCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([isActive])
}

// ============ MENSAJES DE CONTACTO ============
model ContactMessage {
  id      String  @id @default(cuid())
  name    String
  email   String
  phone   String?
  subject String
  message String  @db.Text
  orderId String? // Si es relacionado con un pedido

  // Estado
  status    String    @default("new") // new, read, replied, closed
  repliedAt DateTime?
  repliedBy String? // Admin que respondió

  // Notas internas
  adminNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// ============ PÁGINAS LEGALES/CONTENIDO ============
model Page {
  id              String  @id @default(cuid())
  slug            String  @unique
  title           String
  content         String  @db.Text
  metaTitle       String?
  metaDescription String?
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

// ============ SECCIONES DE HOME ============
enum HomeSectionType {
  PRODUCTS_SLIDER // Slider de productos
  CATEGORIES_GRID // Grid de categorías
  BANNER // Banner promocional
  TEXT_BLOCK // Bloque de texto
}

model HomeSection {
  id       String          @id @default(cuid())
  title    String // "Los Más Vendidos", "Novedades", etc.
  subtitle String?
  type     HomeSectionType

  // Configuración del contenido
  // Para PRODUCTS_SLIDER: filtro de productos (featured, new, bestseller, category)
  // Para CATEGORIES_GRID: array de categorías a mostrar
  // Para BANNER: imagen, link, texto
  config Json?

  // Orden de visualización
  displayOrder Int @default(0)

  // Visibilidad
  isActive Boolean @default(true)

  // Link "Ver todo"
  linkUrl  String?
  linkText String? @default("Ver todo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
}

// ============ PAGE BUILDER ============
model DynamicPage {
  id          String  @id @default(cuid())
  slug        String  @unique
  title       String
  description String? @db.Text

  // Bloques de contenido
  blocks PageBlock[]

  // SEO
  metaTitle       String?
  metaDescription String?
  metaImage       String?

  // Estado
  isActive   Boolean   @default(false)
  isHomePage Boolean   @default(false) // Para marcar como página de inicio
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@index([isHomePage])
}

model PageBlock {
  id     String      @id @default(cuid())
  pageId String
  page   DynamicPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Tipo: 'hero', 'product-slider', 'bento-grid'
  type  String
  title String? // Título interno para identificar el bloque

  // Configuración flexible según el tipo
  config Json

  // Orden y visibilidad
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId])
  @@index([type])
  @@index([displayOrder])
}

// ============ TPV - PUNTO DE VENTA ============
enum PosPaymentMethod {
  CASH      // Efectivo
  CARD      // Tarjeta
  BIZUM     // Bizum
  MIXED     // Pago mixto (efectivo + tarjeta)
}

enum PosSaleStatus {
  COMPLETED   // Venta completada
  REFUNDED    // Devuelta completamente
  PARTIAL_REFUND // Devolución parcial
  VOIDED      // Anulada (antes de cerrar caja)
}

// Sesión de caja (turno de trabajo)
model PosCashSession {
  id        String   @id @default(cuid())

  // Usuario que abre la caja
  adminId   String
  adminName String

  // Fondo inicial y cierre
  openingAmount  Decimal   @db.Decimal(10, 2) // Fondo de caja al abrir
  closingAmount  Decimal?  @db.Decimal(10, 2) // Total en caja al cerrar
  expectedAmount Decimal?  @db.Decimal(10, 2) // Lo que debería haber (calculado)
  difference     Decimal?  @db.Decimal(10, 2) // Diferencia (descuadre)

  // Desglose del cierre
  closingCash    Decimal?  @db.Decimal(10, 2)
  closingCard    Decimal?  @db.Decimal(10, 2)
  closingBizum   Decimal?  @db.Decimal(10, 2)

  // Notas
  openingNotes  String?  @db.Text
  closingNotes  String?  @db.Text

  // Timestamps
  openedAt  DateTime  @default(now())
  closedAt  DateTime?

  // Ventas de esta sesión
  sales PosSale[]

  // Movimientos de caja (entradas/salidas de efectivo)
  movements PosCashMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([adminId])
  @@index([openedAt])
  @@index([closedAt])
}

// Movimientos de caja (entradas/salidas que no son ventas)
model PosCashMovement {
  id        String @id @default(cuid())
  sessionId String
  session   PosCashSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type      String  // 'in' (entrada) o 'out' (salida)
  amount    Decimal @db.Decimal(10, 2)
  reason    String  // "Cambio para caja", "Pago a proveedor", etc.

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([type])
}

// Venta en tienda física
model PosSale {
  id          String   @id @default(cuid())
  saleNumber  String   @unique // TPV-20260119-0001

  // Sesión de caja
  sessionId   String
  session     PosCashSession @relation(fields: [sessionId], references: [id])

  // Items vendidos
  items       PosSaleItem[]

  // Totales
  subtotal    Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)

  // Pago
  paymentMethod PosPaymentMethod
  cashReceived  Decimal? @db.Decimal(10, 2) // Efectivo recibido
  cashChange    Decimal? @db.Decimal(10, 2) // Cambio devuelto
  cardAmount    Decimal? @db.Decimal(10, 2) // Parte pagada con tarjeta
  bizumAmount   Decimal? @db.Decimal(10, 2) // Parte pagada con Bizum

  // Cliente (opcional)
  customerId    String?
  customerName  String?
  customerEmail String?
  customerPhone String?

  // Estado
  status      PosSaleStatus @default(COMPLETED)

  // Ticket impreso
  ticketPrinted Boolean @default(false)

  // Notas
  notes String? @db.Text

  // Devoluciones asociadas
  refunds PosSaleRefund[]

  // Registro Verifactu (si está habilitado)
  verifactuRecord VerifactuRecord?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([saleNumber])
  @@index([status])
  @@index([createdAt])
  @@index([customerId])
}

// Items de una venta TPV
model PosSaleItem {
  id        String  @id @default(cuid())
  saleId    String
  sale      PosSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  // Producto
  productId   String
  variantId   String?

  // Snapshot del producto (por si cambia)
  productName    String
  productBarcode String?
  productSku     String?
  variantInfo    String? // "Talla M, Color Azul"

  // Cantidades y precios
  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  discount   Decimal @default(0) @db.Decimal(10, 2) // Descuento por item
  totalPrice Decimal @db.Decimal(10, 2)

  // Para devoluciones parciales
  refundedQuantity Int @default(0)

  @@index([saleId])
  @@index([productId])
}

// Devoluciones
model PosSaleRefund {
  id        String  @id @default(cuid())
  saleId    String
  sale      PosSale @relation(fields: [saleId], references: [id])

  // Número de devolución
  refundNumber String @unique // DEV-20260119-0001

  // Monto devuelto
  amount    Decimal @db.Decimal(10, 2)

  // Método de devolución
  refundMethod String // 'cash', 'card', 'voucher' (vale de compra)

  // Si genera vale de compra
  voucherCode   String?
  voucherAmount Decimal? @db.Decimal(10, 2)

  // Razón
  reason String? @db.Text

  // Admin que procesa
  processedBy String

  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([refundNumber])
  @@index([voucherCode])
}

// Vales de compra (generados por devoluciones)
model PosVoucher {
  id          String   @id @default(cuid())
  code        String   @unique // Vale-XXXX
  amount      Decimal  @db.Decimal(10, 2)
  usedAmount  Decimal  @default(0) @db.Decimal(10, 2)

  // Origen
  originRefundId String?

  // Cliente
  customerName  String?
  customerPhone String?

  // Validez
  expiresAt DateTime?
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

// ============ VERIFACTU - FACTURACIÓN ELECTRÓNICA AEAT ============
enum VerifactuStatus {
  PENDING     // Pendiente de envío
  SUBMITTED   // Enviado a AEAT
  ACCEPTED    // Aceptado por AEAT
  REJECTED    // Rechazado por AEAT
  CANCELLED   // Anulado
}

enum VerifactuInvoiceType {
  F1  // Factura completa
  F2  // Factura simplificada (ticket)
  R1  // Factura rectificativa (por error fundado de derecho)
  R2  // Factura rectificativa (por error en importe)
  R3  // Factura rectificativa (por devolución)
  R4  // Factura rectificativa (resto de casos)
  R5  // Factura rectificativa (facturas simplificadas)
}

// Registro de facturación para Verifactu
model VerifactuRecord {
  id                String   @id @default(cuid())

  // Identificación de la factura
  invoiceNumber     String   @unique  // Serie + Número (TPV-20260119-0001)
  invoiceDate       DateTime
  invoiceType       VerifactuInvoiceType @default(F2)  // F2 = Simplificada (ticket)

  // Datos del emisor
  issuerNif         String
  issuerName        String

  // Datos del receptor (opcional para facturas simplificadas)
  recipientNif      String?
  recipientName     String?

  // Importes
  baseAmount        Decimal  @db.Decimal(10, 2)  // Base imponible
  taxRate           Decimal  @db.Decimal(5, 2)   // Tipo IVA (21.00, 10.00, 4.00, 0.00)
  taxAmount         Decimal  @db.Decimal(10, 2)  // Cuota de IVA
  totalAmount       Decimal  @db.Decimal(10, 2)  // Total factura

  // Encadenamiento de hash (clave de Verifactu)
  previousHash      String?  // Hash del registro anterior (null si es el primero)
  currentHash       String   // SHA-256 de este registro
  hashInput         String   @db.Text  // Datos usados para generar el hash (para auditoría)

  // Código QR
  qrContent         String   @db.Text  // URL de verificación para el QR

  // Estado de envío a AEAT
  status            VerifactuStatus @default(PENDING)
  aeatResponse      Json?    // Respuesta completa de AEAT
  aeatErrorCode     String?  // Código de error si fue rechazado
  aeatErrorMessage  String?  // Mensaje de error
  submittedAt       DateTime?

  // Relación con venta TPV (opcional, puede ser factura manual)
  saleId            String?  @unique
  sale              PosSale? @relation(fields: [saleId], references: [id])

  // Contenido XML enviado a AEAT
  xmlContent        String   @db.Text

  // Para facturas rectificativas: referencia a la original
  originalInvoiceId String?
  originalInvoice   VerifactuRecord? @relation("RectificativeInvoices", fields: [originalInvoiceId], references: [id])
  rectifications    VerifactuRecord[] @relation("RectificativeInvoices")

  // Metadatos
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([status])
  @@index([issuerNif])
  @@index([saleId])
  @@index([createdAt])
}
